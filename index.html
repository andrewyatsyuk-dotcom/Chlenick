<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>üçû –ü–µ–∫–∞—Ä–Ω—è ‚Äî –•–ª—ñ–± ‚Üí –ü–µ—á–∏–≤–æ ‚Üí –ë—É–ª–æ—á–∫–∏ ‚Üí –ü–∏—Ä—ñ–∂–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      --card: rgba(255,255,255,0.08);
      --card-hover: rgba(255,255,255,0.12);
      --text: #e8e8e8;
      --accent: #e94560;
      --gold: #fdcb6e;
      --success: #00b894;
      --border: rgba(255,255,255,0.1);
    }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      min-height: 100dvh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      padding-top: max(12px, env(safe-area-inset-top) + 52px);
      padding-left: max(12px, env(safe-area-inset-left));
      padding-right: max(12px, env(safe-area-inset-right));
      overflow-x: hidden;
    }
    .app-header { flex-shrink: 0; }
    h1 { font-size: 1.3rem; margin-bottom: 8px; color: white; text-align: center; }
    .app-content {
      flex: 1;
      width: 100%;
      max-width: 400px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-left: 2px;
      padding-right: 2px;
    }
    .tabs {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      padding: 10px 0;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      flex-wrap: wrap;
      justify-content: center;
      flex-shrink: 0;
    }
    .tab {
      padding: 8px 14px; border: 1px solid var(--border); border-radius: 10px;
      background: var(--card); color: var(--text); font-weight: 600; cursor: pointer;
      font-size: 0.85rem; transition: all 0.2s;
    }
    .tab:hover, .tab.active { background: var(--accent); color: white; border-color: var(--accent); }
    .view { display: none; width: 100%; max-width: 400px; flex-direction: column; align-items: center; }
    .view.active { display: flex; }

    .stats-panel {
      width: 100%; background: var(--card); border-radius: 12px; padding: 10px; margin-bottom: 10px;
      border: 1px solid var(--border); display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
      max-height: 220px; overflow-y: auto;
    }
    .stat { text-align: center; padding: 4px 2px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.7rem; }
    .stat-val { font-weight: 800; color: var(--gold); font-size: 0.8rem; }
    .stat-cps { font-size: 0.6rem; opacity: 0.7; color: var(--success); }
    .storage-timer {
      width: 100%; text-align: center; font-size: 0.8rem; padding: 6px 10px; margin-bottom: 6px;
      background: rgba(0,0,0,0.2); border-radius: 8px; color: var(--gold);
    }

    .status-bars {
      width: 100%; background: var(--card); border-radius: 12px; padding: 10px; margin-bottom: 10px;
      border: 1px solid var(--border);
    }
    .status-bars h3 { font-size: 0.85rem; margin-bottom: 8px; opacity: 0.9; }
    .status-bar-row { margin-bottom: 8px; }
    .status-bar-row:last-child { margin-bottom: 0; }
    .status-bar-label { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; margin-bottom: 2px; }
    .status-bar-wrap { height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
    .status-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; min-width: 2px; }

    .settings-row { width: 100%; text-align: center; margin-top: 8px; }
    .btn-reset { padding: 6px 12px; font-size: 0.75rem; background: rgba(233,69,96,0.3); border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); cursor: pointer; }
    .btn-cheats { padding: 6px 12px; font-size: 0.75rem; background: rgba(46,213,115,0.3); border: 1px solid var(--success); border-radius: 8px; color: var(--success); cursor: pointer; margin-left: 6px; }
    .cheats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0; }
    .btn-cheats-action { padding: 8px 12px; font-size: 0.8rem; background: rgba(46,213,115,0.2); border: 1px solid var(--success); border-radius: 8px; color: var(--success); cursor: pointer; }

    .clicker-wrap {
      flex-shrink: 0;
      display: flex; flex-direction: column; align-items: center; padding: 10px 0 6px;
      margin-bottom: 4px;
    }
    .clicker-hint { font-size: 0.75rem; opacity: 0.7; margin-top: 4px; }
    .clicker {
      width: 120px; height: 120px;
      background: linear-gradient(145deg, #2d5016, #4a7c23);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 3.2rem; cursor: pointer; user-select: none;
      box-shadow: 0 6px 24px rgba(74,124,35,0.5); transition: transform 0.08s;
      border: 4px solid #5a9c2a; -webkit-tap-highlight-color: transparent;
    }
    .clicker:active { transform: scale(0.92); }

    .section {
      width: 100%; background: var(--card); border-radius: 12px; padding: 14px; margin-bottom: 10px;
      border: 1px solid var(--border); max-height: min(65vh, 520px); overflow-y: auto;
    }
    .section h2 { font-size: 0.95rem; margin-bottom: 10px; opacity: 0.9; }
    .building, .upgrade-item, .achieve-item {
      display: flex; align-items: center; justify-content: space-between; padding: 10px;
      margin-bottom: 6px; background: rgba(0,0,0,0.2); border-radius: 10px;
      transition: background 0.2s; gap: 8px;
    }
    .building:hover, .upgrade-item:hover { background: var(--card-hover); }
    .building-info, .upgrade-info { flex: 1; min-width: 0; }
    .building-name, .upgrade-name { font-weight: 700; font-size: 0.9rem; }
    .building-desc, .upgrade-desc { font-size: 0.7rem; opacity: 0.6; }
    .building-stats { font-size: 0.7rem; color: var(--success); }
    .btn-buy {
      padding: 8px 12px; background: linear-gradient(135deg, #667eea, #764ba2);
      border: none; border-radius: 8px; color: white; font-weight: 700; font-size: 0.8rem;
      cursor: pointer; white-space: nowrap; flex-shrink: 0;
    }
    .btn-buy:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
    .btn-buy:active:not(:disabled) { transform: scale(0.95); }

    .floating-coin {
      position: fixed; pointer-events: none; font-size: 1.2rem; font-weight: 800; color: var(--gold);
      animation: floatUp 0.8s ease-out forwards; z-index: 100;
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
    }

    .lb-list { width: 100%; background: var(--card); border-radius: 12px; overflow: hidden; }
    .lb-row { display: flex; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border); gap: 8px; }
    .lb-row.lb-row-tg { cursor: pointer; }
    .lb-row.me { background: rgba(233,69,96,0.2); }
    .lb-row .lb-open { font-size: 1rem; opacity: 0.7; }
    .lb-rank { font-weight: 900; width: 28px; text-align: center; }
    .lb-name { flex: 1; font-weight: 600; font-size: 0.9rem; }
    .lb-score { font-weight: 800; color: var(--gold); font-size: 0.9rem; }
    .lb-empty { padding: 20px; text-align: center; opacity: 0.6; font-size: 0.9rem; }
    .lb-refresh { width: 100%; padding: 12px; margin-top: 8px; background: var(--accent); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; }

    .achieve-item.unlocked { border-left: 4px solid var(--success); }
    .achieve-item .badge { font-size: 1.2rem; margin-right: 8px; }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.hidden { display: none; }
    .modal-box {
      background: linear-gradient(180deg, #1a1a2e, #16213e); border: 1px solid var(--border);
      border-radius: 16px; padding: 24px; max-width: 340px; max-height: 85vh; overflow-y: auto;
    }
    .modal-box h2 { font-size: 1.1rem; margin-bottom: 12px; color: var(--gold); }
    .modal-box p { font-size: 0.9rem; line-height: 1.5; opacity: 0.9; margin-bottom: 12px; }
    .modal-btn { width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem; }
    .trade-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; margin-bottom: 8px; background: rgba(0,0,0,0.2); border-radius: 10px; gap: 8px; flex-wrap: wrap; }
    .trade-row .trade-desc { flex: 1; min-width: 0; font-size: 0.85rem; }
    .gift-form select, .gift-form input { padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); margin: 4px 0; }
    .friend-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 6px; }
    .boost-badge { font-size: 0.75rem; background: var(--success); color: white; padding: 2px 8px; border-radius: 6px; }
  </style>
</head>
<body>
  <div id="intro-modal" class="modal-overlay">
    <div class="modal-box">
      <h2>üåæ –Ø–∫ —Ç–∏ —Ç—É—Ç –æ–ø–∏–Ω–∏–≤—Å—è</h2>
      <p>–ü—Ä–æ–∫–∏–Ω—É–≤—Å—è —Ç–∏ –≤ –ø–æ–ª—ñ –±—ñ–ª—è –Ω–µ–≤–µ–ª–∏–∫–æ–≥–æ —Å–µ–ª–∞. –£ –∫–∏—à–µ–Ω—ñ ‚Äî –∫—ñ–ª—å–∫–∞ –º–æ–Ω–µ—Ç, –ø—ñ–¥ –Ω–æ–≥–∞–º–∏ ‚Äî –∑–æ–ª–æ—Ç–∞ –ø—à–µ–Ω–∏—Ü—è. –ú—ñ—Å—Ü–µ–≤—ñ —Å–∫–∞–∑–∞–ª–∏: —Ö—Ç–æ –∑–±–∏—Ä–∞—î –∑–µ—Ä–Ω–æ —ñ –≤–º—ñ—î –π–æ–≥–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–∞ —Ö–ª—ñ–± ‚Äî —Ç–æ–π —Ç—É—Ç —ñ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è.</p>
      <p>–¢–∏ –≤–∏—Ä—ñ—à–∏–≤ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏. –°–ø–æ—á–∞—Ç–∫—É ‚Äî —Å–µ—Ä–ø —ñ —Ä—É–∫–∏, –ø–æ—Ç—ñ–º –º–ª–∏–Ω, –∫—Ä–∏–Ω–∏—Ü—è, —ñ –Ω–∞—Ä–µ—à—Ç—ñ –≤–ª–∞—Å–Ω–∞ –ø–µ–∫–∞—Ä–Ω—è. –®–ª—è—Ö –≤—ñ–¥ –∑–µ—Ä–Ω–∞ –¥–æ –±—É—Ö–∞–Ω–∫–∏, –≤—ñ–¥ –±—É—Ö–∞–Ω–∫–∏ –¥–æ –ø–µ–∫–∞—Ä–Ω—ñ –∑ —ñ–º‚Äô—è–º.</p>
      <p>–î–æ–±—Ä–µ, —â–æ —Å–∞–º–µ —Ç–∏ —Ç—É—Ç. –ü–æ—á–∏–Ω–∞–π –∑–±–∏—Ä–∞—Ç–∏ –ø—à–µ–Ω–∏—Ü—é.</p>
      <button class="modal-btn" onclick="Game.closeIntro()">–ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
    </div>
  </div>

  <div id="cheats-modal" class="modal-overlay hidden">
    <div class="modal-box">
      <h2>üîì –ß—ñ—Ç–∏</h2>
      <div class="cheats-grid">
        <button class="btn-cheats-action" onclick="Game.cheatAddCoins()">ü™ô +10K –º–æ–Ω–µ—Ç</button>
        <button class="btn-cheats-action" onclick="Game.cheatAddResources()">üì¶ –í—Å—ñ —Ä–µ—Å—É—Ä—Å–∏ +1K</button>
        <button class="btn-cheats-action" onclick="Game.cheatUnlockUpgrades()">‚¨ÜÔ∏è –í—Å—ñ –∞–ø–≥—Ä–µ–π–¥–∏</button>
        <button class="btn-cheats-action" onclick="Game.cheatUnlockAchievements()">üèÜ –í—Å—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è</button>
        <button class="btn-cheats-action" onclick="Game.cheatMaxBuildings()">üè≠ –ú–∞–∫—Å –±—É–¥—ñ–≤–ª—ñ</button>
        <button class="btn-cheats-action" onclick="Game.cheatStorage()">üì¶ –ú–∞–∫—Å —Å–∫–ª–∞–¥</button>
      </div>
      <button class="modal-btn" onclick="Game.closeCheats()">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
  </div>

  <div class="app-header">
    <h1 id="app-title">üçû –ü–µ–∫–∞—Ä–Ω—è</h1>
  </div>
  <div class="app-content">
  <div id="view-main" class="view active">
    <div class="stats-panel" id="stats-panel"></div>
    <div class="storage-timer" id="storage-timer"></div>
    <div class="settings-row">
      <button class="btn-reset" onclick="Game.resetProgress()" title="–û–±–Ω—É–ª–∏—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å">üîÑ –û–±–Ω—É–ª–∏—Ç–∏</button>
      <button class="btn-cheats" onclick="Game.openCheats()" title="–ß—ñ—Ç–∏">üîì –ß—ñ—Ç–∏</button>
    </div>
  </div>

  <div id="view-production" class="view">
    <div class="section"><h2>üè≠ –ë—É–¥—ñ–≤–ª—ñ</h2><div id="buildings-list"></div></div>
  </div>

  <div id="view-upgrades" class="view">
    <div class="section"><h2>‚¨ÜÔ∏è –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è</h2><div id="upgrades-list"></div></div>
  </div>

  <div id="view-achievements" class="view">
    <div class="section"><h2>üèÜ –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è</h2><div id="achievements-list"></div></div>
  </div>

  <div id="view-trade" class="view">
    <div class="section">
      <h2>üè™ –†–∏–Ω–æ–∫</h2>
      <p style="font-size:0.8rem;opacity:0.8;margin-bottom:8px;">–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó —ñ–Ω—à–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤. –ü—Ä–∏–π–º–∞–π —É–≥–æ–¥—É ‚Äî —Ç–∏ –≤—ñ–¥–¥–∞—î—à ¬´–•–æ—á—É¬ª, –æ—Ç—Ä–∏–º—É—î—à ¬´–í—ñ–¥–¥–∞—é¬ª.</p>
      <button class="btn-buy" style="margin-bottom:8px" onclick="Game.loadMarket()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
      <div id="market-list"></div>
    </div>
    <div class="section">
      <h2>üìã –ú—ñ–π –æ–±–º—ñ–Ω</h2>
      <div id="my-offers-list"></div>
    </div>
    <div class="section">
      <h2>‚ûï –í–∏—Å—Ç–∞–≤–∏—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é</h2>
      <p style="font-size:0.8rem;opacity:0.8;margin-bottom:6px;">–í—ñ–¥–¥–∞—é (—Ä–µ—Å—É—Ä—Å + –∫—ñ–ª—å–∫—ñ—Å—Ç—å) ‚Üí –•–æ—á—É –æ—Ç—Ä–∏–º–∞—Ç–∏ (—Ä–µ—Å—É—Ä—Å + –∫—ñ–ª—å–∫—ñ—Å—Ç—å).</p>
      <div id="create-offer-form"></div>
    </div>
  </div>

  <div id="view-gifts" class="view">
    <div class="section"><h2>üéÅ –ü–æ–¥–∞—Ä—É–Ω–∫–∏</h2><p style="font-size:0.8rem;opacity:0.8;margin-bottom:8px;">–°—Ç–≤–æ—Ä–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ –Ω–∏–∂—á–µ —ñ –ø–æ–¥—ñ–ª–∏—Å—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º ‚Äî —Ö—Ç–æ –≤—ñ–¥–∫—Ä–∏—î, –æ—Ç—Ä–∏–º–∞—î —Ä–µ—Å—É—Ä—Å–∏ —ñ —Å—Ç–∞–Ω–µ –¥—Ä—É–≥–æ–º.</p><div id="gifts-out-list"></div><h3 style="font-size:0.9rem;margin:12px 0 6px;">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫</h3><div class="gift-form" id="gift-form"></div></div>
    <div class="section"><h2>üë• –î—Ä—É–∑—ñ —Ç–∞ –±—É—Å—Ç</h2><p style="font-size:0.8rem;opacity:0.8;margin-bottom:8px;">–î—Ä—É–∑—ñ –º–æ–∂—É—Ç—å –¥–∞—Ç–∏ –±—É—Å—Ç √ó2 –Ω–∞ 30 —Ö–≤ (1 —Ä–∞–∑ –Ω–∞ –¥–µ–Ω—å).</p><div id="friends-list"></div></div>
  </div>

  <div id="view-leaderboard" class="view">
    <div class="lb-list"><div id="lb-global" class="lb-empty">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
    <button class="lb-refresh" onclick="Game.loadLeaderboard()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
  </div>
  </div>

  <div class="clicker-wrap">
    <div class="clicker" id="clicker" onclick="Game.click()">‚õèÔ∏è</div>
    <span class="clicker-hint">–ë–æ–≥ –¥–∞–≤ –¥–≤—ñ –ª–æ–ø–∞—Ç–∏ ‚Äî –∫–æ–ø–∞–π!</span>
    <span class="clicker-hint" id="click-percent" style="font-size:0.7rem;opacity:0.8;"></span>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="Game.switchTab('main')">üéÆ –ì—Ä–∞</button>
    <button class="tab" onclick="Game.switchTab('production')">üè≠ –í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ</button>
    <button class="tab" onclick="Game.switchTab('upgrades')">‚¨ÜÔ∏è –ê–ø–≥—Ä–µ–π–¥–∏</button>
    <button class="tab" onclick="Game.switchTab('trade')">üè™ –¢–æ—Ä–≥—ñ–≤–ª—è</button>
    <button class="tab" onclick="Game.switchTab('gifts')">üéÅ –î—Ä—É–∑—ñ</button>
    <button class="tab" onclick="Game.switchTab('leaderboard')">üìä –¢–æ–ø</button>
  </div>

<script>
(function() {
  const LS_KEY = 'bakery_game_v2';
  const FIREBASE_URL = 'https://leaderboardcookie-default-rtdb.firebaseio.com';
  const BOT_USERNAME = 'NeAntonina_bot';
  const OFFLINE_MAX_SEC = 86400;
  const SAVE_INTERVAL_MS = 30000;
  const BOOST_DURATION_MS = 30 * 60 * 1000;
  const BOOST_COOLDOWN_MS = 24 * 60 * 60 * 1000;

  const TRADE_RESOURCES = ['wheat', 'flour', 'water', 'sugar', 'eggs', 'butter', 'dough', 'bread', 'cookies', 'buns', 'pies', 'cake', 'coins'];

  let _audioCtx = null;
  function getAudioCtx() {
    if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return _audioCtx;
  }
  function playSound(type) {
    try {
      const ctx = getAudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      if (type === 'click') {
        osc.frequency.setValueAtTime(400, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.05);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.08);
      } else if (type === 'buy') {
        osc.frequency.setValueAtTime(600, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.12, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.12);
      } else if (type === 'achievement') {
        osc.frequency.setValueAtTime(440, ctx.currentTime);
        osc.frequency.setValueAtTime(554, ctx.currentTime + 0.08);
        osc.frequency.setValueAtTime(659, ctx.currentTime + 0.16);
        gain.gain.setValueAtTime(0.15, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      }
    } catch(e) {}
  }

  function format(val) {
    const n = typeof val === 'object' && val.toNumber ? val.toNumber() : +val;
    if (n >= 1e15) return (n / 1e15).toFixed(1) + 'Qd';
    if (n >= 1e12) return (n / 1e12).toFixed(1) + 'T';
    if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return Math.floor(n).toString();
  }

  const RESOURCES = {
    wheat: { key: 'wheat', name: '–ü—à–µ–Ω–∏—Ü—è', icon: 'üåæ', cps: 0 },
    flour: { key: 'flour', name: '–ë–æ—Ä–æ—à–Ω–æ', icon: 'ü´ô', cps: 0 },
    sugar: { key: 'sugar', name: '–¶—É–∫–æ—Ä', icon: 'üßÇ', cps: 0 },
    water: { key: 'water', name: '–í–æ–¥–∞', icon: 'üíß', cps: 0 },
    eggs: { key: 'eggs', name: '–Ø–π—Ü—è', icon: 'ü•ö', cps: 0 },
    butter: { key: 'butter', name: '–ú–∞—Å–ª–æ', icon: 'üßà', cps: 0 },
    dough: { key: 'dough', name: '–¢—ñ—Å—Ç–æ', icon: 'ü•£', cps: 0 },
    bread: { key: 'bread', name: '–•–ª—ñ–±', icon: 'üçû', cps: 0, stage: 1 },
    cookies: { key: 'cookies', name: '–ü–µ—á–∏–≤–æ', icon: 'üç™', cps: 0, stage: 2 },
    buns: { key: 'buns', name: '–ë—É–ª–æ—á–∫–∏', icon: 'ü•ê', cps: 0, stage: 3 },
    pies: { key: 'pies', name: '–ü–∏—Ä—ñ–∂–∫–∏', icon: 'ü•ü', cps: 0, stage: 4 },
    cake: { key: 'cake', name: '–¢–æ—Ä—Ç', icon: 'üéÇ', cps: 0, stage: 5 },
    coins: { key: 'coins', name: '–ú–æ–Ω–µ—Ç–∏', icon: 'ü™ô', cps: 0 }
  };

  const STORAGE_BASE = { wheat: 500, flour: 400, water: 300, sugar: 200, eggs: 200, butter: 200, dough: 300, bread: 400, cookies: 300, buns: 300, pies: 200, cake: 200, coins: 1e9 };
  const STORAGE_PER_LEVEL = { wheat: 500, flour: 400, water: 300, sugar: 200, eggs: 200, butter: 200, dough: 300, bread: 400, cookies: 300, buns: 300, pies: 200, cake: 200, coins: 0 };

  const BUILDINGS = [
    { id: 'storage', name: '–°–∫–ª–∞–¥', desc: '–ú—ñ—Å—Ü–µ –¥–ª—è –ø—à–µ–Ω–∏—Ü—ñ, –±–æ—Ä–æ—à–Ω–∞ —Ç–æ—â–æ. –ü–æ–∫—Ä–∞—â—É–π, —â–æ–± –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –±—ñ–ª—å—à–µ.', resource: 'storage', costRes: 'coins', cost: 50, costMult: 1.2, prod: 0, isStorage: true },
    { id: 'wheat_farm', name: '–§–µ—Ä–º–∞ –ø—à–µ–Ω–∏—Ü—ñ', desc: '–í–∏—Ä–æ—â—É—î –ø—à–µ–Ω–∏—Ü—é', resource: 'wheat', costRes: 'coins', cost: 10, costMult: 1.15, prod: 0.5 },
    { id: 'stall', name: '–õ–∞—Ä—á–∏–∫ –∑ –∑–µ—Ä–Ω–æ–º', desc: '15 –ø—à–µ–Ω–∏—Ü—ñ‚Üí1 –º–æ–Ω–µ—Ç–∞', resource: 'coins', costRes: 'wheat', cost: 100, costMult: 1.2, prod: 0.1, consumes: { wheat: 1.5 } },
    { id: 'mill', name: '–ú–ª–∏–Ω', desc: '10 –ø—à–µ–Ω–∏—Ü—ñ‚Üí1 –±–æ—Ä–æ—à–Ω–æ', resource: 'flour', costRes: 'coins', cost: 100, costMult: 1.15, prod: 0.5, consumes: { wheat: 5 } },
    { id: 'well', name: '–ö—Ä–∏–Ω–∏—Ü—è', desc: '–î–æ–±—É–≤–∞—î –≤–æ–¥—É', resource: 'water', costRes: 'coins', cost: 55, costMult: 1.15, prod: 0.5 },
    { id: 'baker', name: '–ü–µ–∫–∞—Ä–Ω—è', desc: '5 –±–æ—Ä–æ—à–Ω–∞+3 –≤–æ–¥–∏‚Üí1 —Ö–ª—ñ–±', resource: 'bread', costRes: 'coins', cost: 80, costMult: 1.15, prod: 0.5, consumes: { flour: 2.5, water: 1.5 } },
    { id: 'bread_shop', name: '–õ–∞—Ä—á–∏–∫ –∑ —Ö–ª—ñ–±–æ–º', desc: '4 —Ö–ª—ñ–±–∏‚Üí1 –º–æ–Ω–µ—Ç–∞', resource: 'coins', costRes: 'bread', cost: 50, costMult: 1.2, prod: 0.2, consumes: { bread: 0.8 } },
    { id: 'sugar_factory', name: '–¶—É–∫—Ä–æ–≤–∏–π –∑–∞–≤–æ–¥', desc: '–í–∏—Ä–æ–±–ª—è—î —Ü—É–∫–æ—Ä', resource: 'sugar', costRes: 'coins', cost: 400, costMult: 1.15, prod: 0.3 },
    { id: 'chicken_coop', name: '–ö—É—Ä–Ω–∏–∫', desc: '–ù–µ—Å–µ —è–π—Ü—è', resource: 'eggs', costRes: 'coins', cost: 350, costMult: 1.15, prod: 0.2 },
    { id: 'dairy_farm', name: '–ú–æ–ª–æ—á–Ω–∞ —Ñ–µ—Ä–º–∞', desc: '–ö–æ—Ä–æ–≤–∏‚Üí–ú–∞—Å–ª–æ', resource: 'butter', costRes: 'coins', cost: 1200, costMult: 1.15, prod: 0.15 },
    { id: 'mixer', name: '–ú—ñ–∫—Å–µ—Ä', desc: '3 –±–æ—Ä–æ—à–Ω–∞+2 –≤–æ–¥–∏+1 —Ü—É–∫–æ—Ä+1 —è–π—Ü–µ‚Üí1 —Ç—ñ—Å—Ç–æ', resource: 'dough', costRes: 'coins', cost: 2000, costMult: 1.15, prod: 0.2, consumes: { flour: 0.6, water: 0.4, sugar: 0.2, eggs: 0.2 } },
    { id: 'oven', name: '–ü—ñ—á –¥–ª—è –ø–µ—á–∏–≤–∞', desc: '4 —Ç—ñ—Å—Ç–∞+2 –º–∞—Å–ª–∞‚Üí1 –ø–µ—á–∏–≤–æ', resource: 'cookies', costRes: 'coins', cost: 5000, costMult: 1.15, prod: 0.1, consumes: { dough: 0.4, butter: 0.2 } },
    { id: 'cookie_market', name: '–†–∏–Ω–æ–∫ –ø–µ—á–∏–≤–∞', desc: '3 –ø–µ—á–∏–≤–∞‚Üí1 –º–æ–Ω–µ—Ç–∞', resource: 'coins', costRes: 'cookies', cost: 100, costMult: 1.15, prod: 0.4, consumes: { cookies: 1.2 } },
    { id: 'buns_oven', name: '–ü—ñ—á –¥–ª—è –±—É–ª–æ—á–æ–∫', desc: '5 —Ç—ñ—Å—Ç–∞+2 –º–∞—Å–ª–∞+1 —Ü—É–∫–æ—Ä‚Üí1 –±—É–ª–æ—á–∫–∞', resource: 'buns', costRes: 'coins', cost: 12000, costMult: 1.15, prod: 0.08, consumes: { dough: 0.4, butter: 0.16, sugar: 0.08 } },
    { id: 'buns_shop', name: '–õ–∞—Ä—á–∏–∫ –∑ –±—É–ª–æ—á–∫–∞–º–∏', desc: '2 –±—É–ª–æ—á–∫–∏‚Üí1 –º–æ–Ω–µ—Ç–∞', resource: 'coins', costRes: 'buns', cost: 200, costMult: 1.15, prod: 0.5, consumes: { buns: 1 } },
    { id: 'pies_oven', name: '–ü—ñ—á –¥–ª—è –ø–∏—Ä—ñ–∂–∫—ñ–≤', desc: '6 —Ç—ñ—Å—Ç–∞+3 –º–∞—Å–ª–∞+2 —è–π—Ü—è‚Üí1 –ø–∏—Ä—ñ–∂–æ–∫', resource: 'pies', costRes: 'coins', cost: 25000, costMult: 1.15, prod: 0.06, consumes: { dough: 0.36, butter: 0.18, eggs: 0.12 } },
    { id: 'pies_shop', name: '–õ–∞—Ä—á–∏–∫ –∑ –ø–∏—Ä—ñ–∂–∫–∞–º–∏', desc: '1 –ø–∏—Ä—ñ–∂–æ–∫‚Üí1 –º–æ–Ω–µ—Ç–∞', resource: 'coins', costRes: 'pies', cost: 400, costMult: 1.15, prod: 0.8, consumes: { pies: 0.8 } },
    { id: 'confectionery', name: '–ö–æ–Ω–¥–∏—Ç–µ—Ä—Å—å–∫–∞', desc: '8 —Ç—ñ—Å—Ç–∞+4 –º–∞—Å–ª–∞+3 —Ü—É–∫—Ä—É+3 —è–π—Ü—è‚Üí1 —Ç–æ—Ä—Ç', resource: 'cake', costRes: 'coins', cost: 35000, costMult: 1.15, prod: 0.05, consumes: { dough: 0.4, butter: 0.2, sugar: 0.15, eggs: 0.15 } },
    { id: 'cake_shop', name: '–õ–∞—Ä—á–∏–∫ –∑ —Ç–æ—Ä—Ç–∞–º–∏', desc: '1 —Ç–æ—Ä—Ç‚Üí1 –º–æ–Ω–µ—Ç–∞', resource: 'coins', costRes: 'cake', cost: 500, costMult: 1.15, prod: 0.5, consumes: { cake: 0.5 } },
    { id: 'water_mill', name: '–í–æ–¥—è–Ω–∏–π –º–ª–∏–Ω', desc: '8 –ø—à–µ–Ω–∏—Ü—ñ+0.5 –≤–æ–¥–∏‚Üí1 –±–æ—Ä–æ—à–Ω–æ', resource: 'flour', costRes: 'coins', cost: 600, costMult: 1.15, prod: 1.5, consumes: { wheat: 12, water: 0.75 } },
    { id: 'steam_mill', name: '–ü–∞—Ä–æ–≤–∏–π –º–ª–∏–Ω', desc: '6 –ø—à–µ–Ω–∏—Ü—ñ+1 –≤–æ–¥–∞‚Üí1 –±–æ—Ä–æ—à–Ω–æ', resource: 'flour', costRes: 'coins', cost: 1800, costMult: 1.15, prod: 4, consumes: { wheat: 24, water: 4 } }
  ];

  const UPGRADES = [
    { id: 'u1', name: '–ú—ñ—Ü–Ω—ñ—à—ñ –º—ñ—à–∫–∏', desc: '√ó2 –ø—à–µ–Ω–∏—Ü—ñ', cost: 100, costRes: 'coins', target: 'wheat', mult: 2 },
    { id: 'u1b', name: '–Ø—á–º—ñ–Ω–Ω—ñ –∂–æ—Ä–Ω–∞', desc: '√ó1.5 –±–æ—Ä–æ—à–Ω–∞ (–∑–∞ –ø—à–µ–Ω–∏—Ü—é)', cost: 200, costRes: 'wheat', target: 'flour', mult: 1.5 },
    { id: 'u2', name: '–ñ–æ—Ä–Ω–∞', desc: '√ó2 –±–æ—Ä–æ—à–Ω–∞', cost: 500, costRes: 'coins', target: 'flour', mult: 2 },
    { id: 'u2b', name: '–î—Ä—ñ–∂–¥–∂—ñ', desc: '√ó2 —Ö–ª—ñ–±–∞', cost: 300, costRes: 'coins', target: 'bread', mult: 2 },
    { id: 'u3', name: '–ö—Ä–∞–Ω', desc: '√ó2 –≤–æ–¥–∏', cost: 300, costRes: 'coins', target: 'water', mult: 2 },
    { id: 'u4', name: '–§–µ—Ä–º–µ—Ä—Å—å–∫—ñ –∫—É—Ä–∫–∏', desc: '√ó2 —è—î—Ü—å', cost: 800, costRes: 'coins', target: 'eggs', mult: 2 },
    { id: 'u5', name: '–°–æ–ª–æ–¥–∫–∞ –ø–µ—á–∫–∞', desc: '√ó2 –ø–µ—á–∏–≤–∞', cost: 2000, costRes: 'coins', target: 'cookies', mult: 2 },
    { id: 'u6', name: '–¢–æ—Ä–≥—ñ–≤–µ–ª—å–Ω–∞ –ª—ñ—Ü–µ–Ω–∑—ñ—è', desc: '√ó2 –º–æ–Ω–µ—Ç', cost: 1000, costRes: 'coins', target: 'coins', mult: 2 },
    { id: 'u7', name: '–ë—É–ª–æ—á–∫–∏ —Å–≤—ñ–∂—ñ', desc: '√ó2 –±—É–ª–æ—á–æ–∫', cost: 5000, costRes: 'coins', target: 'buns', mult: 2 },
    { id: 'u8', name: '–ü–∏—Ä—ñ–∂–∫–∏ —Å–º–∞—á–Ω—ñ', desc: '√ó2 –ø–∏—Ä—ñ–∂–æ–∫', cost: 10000, costRes: 'coins', target: 'pies', mult: 2 },
    { id: 'u9', name: '–¢–æ—Ä—Ç–∏ –ø—Ä–µ–º—ñ—É–º', desc: '√ó2 —Ç–æ—Ä—Ç—ñ–≤', cost: 15000, costRes: 'coins', target: 'cake', mult: 2 },
    { id: 'u10', name: '–ó–æ–ª–æ—Ç—ñ –∂–æ—Ä–Ω–∞', desc: '√ó2 –ø—à–µ–Ω–∏—Ü—ñ', cost: 500, costRes: 'coins', target: 'wheat', mult: 2 },
    { id: 'uc1', name: '–ì–æ—Å—Ç—Ä–∏–π —Å–µ—Ä–ø', desc: '+5% –∑ –∫–ª—ñ–∫—É (–∫–æ–ø–∞–π)', cost: 300, costRes: 'wheat', clickPercent: 5 },
    { id: 'uc2', name: '–ú—ñ—Ü–Ω—ñ –ª–æ–ø–∞—Ç–∏', desc: '+5% –∑ –∫–ª—ñ–∫—É', cost: 500, costRes: 'coins', clickPercent: 5 },
    { id: 'uc3', name: '–ó–∞–ª—ñ–∑–Ω–µ –ª–æ–ø–∞—Ç–∞', desc: '+10% –∑ –∫–ª—ñ–∫—É', cost: 2000, costRes: 'coins', clickPercent: 10 },
    { id: 'uc4', name: '–ë–æ—Ä–æ—à–Ω—è–Ω–∏–π —É–¥–∞—Ä', desc: '+5% –∑ –∫–ª—ñ–∫—É', cost: 800, costRes: 'flour', clickPercent: 5 },
    { id: 'uc5', name: '–ó–æ–ª–æ—Ç–µ –ª–æ–ø–∞—Ç–æ', desc: '+10% –∑ –∫–ª—ñ–∫—É', cost: 8000, costRes: 'coins', clickPercent: 10 },
    { id: 'uc6', name: '–õ–µ–≥–µ–Ω–¥–∞ –∫–æ–ø–∞–ª—å–Ω—ñ', desc: '+15% –∑ –∫–ª—ñ–∫—É', cost: 25000, costRes: 'coins', clickPercent: 15 }
  ];

  const ACHIEVEMENTS = [
    { id: 'a1', name: '–ü–µ—Ä—à–∞ –ø—à–µ–Ω–∏—Ü—è', desc: '1K –ø—à–µ–Ω–∏—Ü—ñ', icon: 'üåæ', check: s => s.wheat >= 1e3 },
    { id: 'a2', name: '–ú–µ–ª—å–Ω–∏–∫', desc: '1K –±–æ—Ä–æ—à–Ω–∞', icon: 'ü´ô', check: s => s.flour >= 1e3 },
    { id: 'a2b', name: '–ü–µ–∫–∞—Ä —Ö–ª—ñ–±–∞', desc: '100 —Ö–ª—ñ–±–∞', icon: 'üçû', check: s => s.bread >= 100 },
    { id: 'a3', name: '–ü–µ–∫–∞—Ä –ø–µ—á–∏–≤–∞', desc: '100 –ø–µ—á–∏–≤–∞', icon: 'üç™', check: s => s.cookies >= 100 },
    { id: 'a3b', name: '–ë—É–ª–æ—á–Ω–∏–∫', desc: '50 –±—É–ª–æ—á–æ–∫', icon: 'ü•ê', check: s => s.buns >= 50 },
    { id: 'a4', name: '–¢–∏—Å—è—á–Ω–∏–∫', desc: '1K –º–æ–Ω–µ—Ç', icon: 'ü™ô', check: s => s.coins >= 1e3 },
    { id: 'a5', name: '–ú–∞–≥–Ω–∞—Ç', desc: '1M –º–æ–Ω–µ—Ç', icon: 'üí∞', check: s => s.coins >= 1e6 },
    { id: 'a6', name: '–®–≤–∏–¥–∫–∞ —Ä—É–∫–∞', desc: '5 –ø—à–µ–Ω–∏—Ü—ñ/—Å–µ–∫', icon: '‚ö°', check: s => (s.wheatCps || 0) >= 5 },
    { id: 'a7', name: '10K –ø—à–µ–Ω–∏—Ü—ñ', desc: '10K –ø—à–µ–Ω–∏—Ü—ñ', icon: 'üåæ', check: s => s.wheat >= 1e4 },
    { id: 'a8', name: '5K –±–æ—Ä–æ—à–Ω–∞', desc: '5K –±–æ—Ä–æ—à–Ω–∞', icon: 'ü´ô', check: s => s.flour >= 5e3 },
    { id: 'a9', name: '500 —Ö–ª—ñ–±–∞', desc: '500 —Ö–ª—ñ–±–∞', icon: 'üçû', check: s => s.bread >= 500 },
    { id: 'a10', name: '–ö–æ–Ω–¥–∏—Ç–µ—Ä', desc: '50 —Ç–æ—Ä—Ç—ñ–≤', icon: 'üéÇ', check: s => (s.cake || 0) >= 50 },
    { id: 'a11', name: '–ú—ñ–ª—å–π–æ–Ω–µ—Ä', desc: '10M –º–æ–Ω–µ—Ç', icon: 'üíé', check: s => s.coins >= 1e7 }
  ];

  const Game = {
    state: {},
    purchased: {},
    boughtUpgrades: new Set(),
    achievements: new Set(),
    lastSave: 0,
    _lastTick: 0,
    _raf: null,
    userId: 'anon_' + Math.random().toString(36).slice(2, 10),
    userName: '–ì—Ä–∞–≤–µ—Ü—å',

    init() {
      try {
        const tg = window.Telegram?.WebApp;
        if (tg) {
          tg.ready();
          tg.expand();
          const u = tg.initDataUnsafe?.user;
          if (u) {
            this.userId = String(u.id);
            this.userName = (u.first_name || '') + (u.last_name ? ' ' + u.last_name[0] + '.' : '');
          }
        }
      } catch(e) {}
      this.load();
      const startParam = window.Telegram?.WebApp?.start_param || '';
      if (startParam && startParam.indexOf('gift_') === 0) {
        this.claimGift(startParam.replace('gift_', '')).then(() => {
          this.continueInit();
        });
      } else {
        this.continueInit();
      }
      setInterval(() => this.save(), SAVE_INTERVAL_MS);
      window.addEventListener('beforeunload', () => this.save());
    },

    continueInit() {
      Promise.resolve(this.loadFromCloud()).then(() => {
        return this.applyBoostsFromCloud();
      }).then(() => {
        this.applyOffline();
        this.render();
        const s = this.getState();
        const introEl = document.getElementById('intro-modal');
        if (introEl) {
          if (s.seenIntro) introEl.classList.add('hidden');
          else this.state.seenIntro = false;
        }
        if (s.seenIntro) this.startLoop();
      });
    },

    closeIntro() {
      this.state.seenIntro = true;
      this.save();
      document.getElementById('intro-modal').classList.add('hidden');
      this.startLoop();
    },

    getState() {
      const s = this.state;
      const def = { wheat: 0, flour: 0, sugar: 0, water: 0, eggs: 0, butter: 0, dough: 0, bread: 0, cookies: 0, buns: 0, pies: 0, cake: 0, coins: 0, seenIntro: false, bakeryName: '', boostActiveUntil: 0, boostMultiplier: 1, clickBonusPercent: 10 };
      const out = { ...def, ...s };
      ['wheat', 'flour', 'sugar', 'water', 'eggs', 'butter', 'dough', 'bread', 'cookies', 'buns', 'pies', 'cake', 'coins'].forEach(r => { out[r] = Math.max(0, out[r] || 0); });
      return out;
    },

    getCount(id) {
      return this.purchased[id] || 0;
    },

    getCost(b) {
      const n = this.getCount(b.id);
      return Math.floor(b.cost * Math.pow(b.costMult, n));
    },

    canAfford(res, amount) {
      const s = this.getState();
      return (s[res] || 0) >= amount;
    },

    spend(res, amount) {
      const cur = this.state[res] || 0;
      this.state[res] = Math.max(0, cur - amount);
    },

    getStorageCap(res) {
      if (res === 'coins') return 1e9;
      const base = STORAGE_BASE[res] || 500;
      const perLevel = STORAGE_PER_LEVEL[res] || 500;
      const levels = this.getCount('storage') || 0;
      return base + perLevel * levels;
    },

    getTimeToFullStorage() {
      const s = this.getState();
      const cps = this.calcCPS();
      const resources = ['wheat', 'flour', 'sugar', 'water', 'eggs', 'butter', 'dough', 'bread', 'cookies', 'buns', 'pies', 'cake'];
      let best = null;
      resources.forEach(r => {
        const cap = this.getStorageCap(r);
        const cur = s[r] || 0;
        const rate = cps[r] || 0;
        if (rate <= 0 || cur >= cap) return;
        const sec = (cap - cur) / rate;
        if (sec > 0 && (!best || sec < best.sec)) {
          const res = RESOURCES[r] || { name: r, icon: 'üì¶' };
          best = { res: r, name: res.name, icon: res.icon, sec };
        }
      });
      return best;
    },

    formatTime(sec) {
      if (sec >= 3600) return (sec / 3600).toFixed(1) + ' –≥–æ–¥';
      if (sec >= 60) return Math.ceil(sec / 60) + ' —Ö–≤';
      return Math.ceil(sec) + ' —Å';
    },

    add(res, amount) {
      if (amount <= 0) return;
      const cap = this.getStorageCap(res);
      const cur = Math.max(0, this.state[res] || 0);
      this.state[res] = Math.min(cap, cur + amount);
    },

    calcCPS() {
      const s = this.getState();
      const cps = { wheat: 0, flour: 0, sugar: 0, water: 0, eggs: 0, butter: 0, dough: 0, bread: 0, cookies: 0, buns: 0, pies: 0, cake: 0, coins: 0 };
      const consumption = { wheat: 0, flour: 0, sugar: 0, water: 0, eggs: 0, butter: 0, dough: 0, bread: 0, cookies: 0, buns: 0, pies: 0, cake: 0, coins: 0 };

      BUILDINGS.forEach(b => {
        if (b.isStorage) return;
        const n = this.getCount(b.id);
        if (n <= 0) return;
        const mult = UPGRADES.filter(u => this.boughtUpgrades.has(u.id) && u.target === b.resource).reduce((m, u) => m * u.mult, 1);
        let prod = b.prod * n * mult;
        let bn = 1;
        if (b.consumes) {
          for (const [res, req] of Object.entries(b.consumes)) {
            const avail = s[res] || 0;
            const needPerSec = req * n;
            if (needPerSec > 0 && avail < needPerSec * 2) bn = Math.min(bn, Math.max(0.1, avail / (needPerSec * 2)));
          }
          prod *= bn;
          for (const [res, req] of Object.entries(b.consumes)) {
            if (consumption[res] !== undefined) consumption[res] += req * n * bn;
          }
        }
        cps[b.resource] += prod;
      });

      ['wheat', 'flour', 'sugar', 'water', 'eggs', 'butter', 'dough', 'bread', 'cookies', 'buns', 'pies', 'cake', 'coins'].forEach(r => {
        cps[r] = (cps[r] || 0) - (consumption[r] || 0);
      });
      if ((s.wheat || 0) > 10000) {
        const wheatExcessPerSec = 5;
        cps.wheat = (cps.wheat || 0) - wheatExcessPerSec;
        cps.flour = (cps.flour || 0) + wheatExcessPerSec * 0.5;
      }
      return cps;
    },

    tick(dt) {
      const s = this.state;

      BUILDINGS.forEach(b => {
        if (b.isStorage) return;
        const n = this.getCount(b.id);
        if (n <= 0) return;
        const mult = UPGRADES.filter(u => this.boughtUpgrades.has(u.id) && u.target === b.resource).reduce((m, u) => m * u.mult, 1);
        let prod = b.prod * n * mult * dt;

        if (b.consumes) {
          let minScale = 1;
          for (const [res, req] of Object.entries(b.consumes)) {
            const avail = this.state[res] || 0;
            const need = req * n * dt;
            if (need > 0) minScale = Math.min(minScale, avail >= need ? 1 : Math.max(0, avail / need));
          }
          prod *= minScale;
          for (const [res, req] of Object.entries(b.consumes)) {
            const take = Math.min(this.state[res] || 0, req * n * dt * minScale);
            if (take > 0) this.spend(res, take);
          }
        }

        let prodMult = 1;
        if ((s.boostActiveUntil || 0) > Date.now() && (s.boostMultiplier || 1) > 1) prodMult = s.boostMultiplier;
        this.add(b.resource, prod * prodMult);
      });

      if ((this.state.wheat || 0) > 10000) {
        const have = this.state.wheat || 0;
        const excess = Math.min(have - 8000, 5 * dt, have);
        if (excess > 0) {
          this.spend('wheat', excess);
          this.add('flour', excess * 0.5);
        }
      }
      const resList = ['wheat', 'flour', 'sugar', 'water', 'eggs', 'butter', 'dough', 'bread', 'cookies', 'buns', 'pies', 'cake', 'coins'];
      resList.forEach(r => { if (this.state[r] < 0) this.state[r] = 0; });
    },

    click() {
      const s = this.getState();
      const cps = this.calcCPS();
      const mult = (s.boostActiveUntil || 0) > Date.now() && (s.boostMultiplier || 1) > 1 ? s.boostMultiplier : 1;
      const clickPct = (s.clickBonusPercent || 10) / 100;
      const resources = ['wheat', 'flour', 'sugar', 'water', 'eggs', 'butter', 'dough', 'bread', 'cookies', 'buns', 'pies', 'cake', 'coins'];
      const gained = [];
      resources.forEach(res => {
        const rate = cps[res] || 0;
        let amount = rate < 0.1 ? (res === 'wheat' ? 1 : 0) : clickPct * rate;
        if (amount > 0) {
          amount *= mult;
          if (res !== 'coins') amount = Math.max(0, Math.floor(amount));
          else amount = Math.max(0, (amount * 10) / 10);
          if (amount > 0) {
            this.add(res, amount);
            const icon = (RESOURCES[res] || {}).icon || 'üì¶';
            const show = res === 'coins' && amount < 10 ? amount.toFixed(1) : (amount >= 1e6 ? (amount/1e6).toFixed(1) + 'M' : amount >= 1e3 ? (amount/1e3).toFixed(1) + 'K' : Math.floor(amount));
            gained.push(icon + ' ' + show);
          }
        }
      });
      if ((cps.coins || 0) < 0.3 && mult >= 1) this.add('coins', 0.3);
      this.showFloating(gained.length ? '+' + (s.clickBonusPercent || 10) + '% ' + gained.slice(0, 5).join(' ') : '+–∫–æ–ø–∞–π!');
      try {
        if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        playSound('click');
      } catch(e) { playSound('click'); }
      this.save();
      this.render();
    },

    showFloating(text) {
      const el = document.createElement('div');
      el.className = 'floating-coin';
      el.textContent = text;
      el.style.left = (window.innerWidth / 2 - 30 + (Math.random() - 0.5) * 40) + 'px';
      el.style.top = '42%';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 800);
    },

    buyBuilding(b) {
      const cost = this.getCost(b);
      const res = b.costRes;
      if (!this.canAfford(res, cost)) return;
      this.spend(res, cost);
      this.purchased[b.id] = (this.purchased[b.id] || 0) + 1;
      if (b.id === 'baker' && this.getCount('baker') === 1 && !this.getState().bakeryName) {
        const name = prompt('–ù–∞–∑–≤–∏ —Å–≤–æ—é –ø–µ–∫–∞—Ä–Ω—é:', '') || '–ú–æ—è –ø–µ–∫–∞—Ä–Ω—è';
        if (name) this.state.bakeryName = String(name).slice(0, 30);
      }
      playSound('buy');
      this.save();
      this.render();
    },

    buyUpgrade(u) {
      if (this.boughtUpgrades.has(u.id)) return;
      if (!this.canAfford(u.costRes, u.cost)) return;
      this.spend(u.costRes, u.cost);
      this.boughtUpgrades.add(u.id);
      if (u.clickPercent) this.state.clickBonusPercent = (this.getState().clickBonusPercent || 10) + u.clickPercent;
      playSound('buy');
      this.save();
      this.render();
    },

    checkAchievements() {
      const s = this.getState();
      const cps = this.calcCPS();
      s.wheatCps = cps.wheat;
      s.breadCps = cps.bread;
      s.cookiesCps = cps.cookies;
      ACHIEVEMENTS.forEach(a => {
        if (!this.achievements.has(a.id) && a.check(s)) {
          this.achievements.add(a.id);
          playSound('achievement');
        }
      });
    },

    resetProgress() {
      if (!confirm('–û–±–Ω—É–ª–∏—Ç–∏ –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å? –¶–µ –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;
      this.state = {};
      this.purchased = {};
      this.boughtUpgrades = new Set();
      this.achievements = new Set();
      this.state.coins = 15;
      this.state.seenIntro = false;
      this.state.bakeryName = '';
      this.lastSave = 0;
      try {
        const data = { state: this.state, purchased: {}, boughtUpgrades: [], achievements: [] };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      } catch(e) {}
      document.getElementById('intro-modal').classList.remove('hidden');
      this.render();
      this.switchTab('main');
    },

    openCheats() {
      document.getElementById('cheats-modal')?.classList.remove('hidden');
    },
    closeCheats() {
      document.getElementById('cheats-modal')?.classList.add('hidden');
    },
    cheatAddCoins() {
      this.add('coins', 10000);
      this.save(); this.render(); playSound('achievement');
    },
    cheatAddResources() {
      ['wheat', 'flour', 'sugar', 'water', 'eggs', 'butter', 'dough', 'bread', 'cookies', 'buns', 'pies', 'cake'].forEach(r => this.add(r, 1000));
      this.add('coins', 5000);
      this.save(); this.render(); playSound('achievement');
    },
    cheatUnlockUpgrades() {
      UPGRADES.forEach(u => this.boughtUpgrades.add(u.id));
      this.save(); this.render(); playSound('achievement');
    },
    cheatUnlockAchievements() {
      ACHIEVEMENTS.forEach(a => this.achievements.add(a.id));
      this.save(); this.render(); playSound('achievement');
    },
    cheatMaxBuildings() {
      BUILDINGS.filter(b => !b.isStorage).forEach(b => { this.purchased[b.id] = (this.purchased[b.id] || 0) + 50; });
      this.purchased['storage'] = (this.purchased['storage'] || 0) + 20;
      this.save(); this.render(); playSound('achievement');
    },
    cheatStorage() {
      this.purchased['storage'] = (this.purchased['storage'] || 0) + 50;
      this.save(); this.render(); playSound('achievement');
    },

    applyOffline() {
      const offline = Math.min((Date.now() - (this.lastSave || Date.now())) / 1000, OFFLINE_MAX_SEC);
      if (offline <= 0) return;
      this.tick(offline);
      this.lastSave = Date.now();
      this.save();
    },

    save() {
      this.state.lastSave = Date.now();
      this.lastSave = Date.now();
      const data = {
        state: this.state,
        purchased: this.purchased,
        boughtUpgrades: [...this.boughtUpgrades],
        achievements: [...this.achievements]
      };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      this.syncCloud();
    },

    load() {
      try {
        const d = localStorage.getItem(LS_KEY);
        if (d) {
          const data = JSON.parse(d);
          this.state = data.state || {};
          this.purchased = data.purchased || {};
          this.boughtUpgrades = new Set(data.boughtUpgrades || []);
          this.achievements = new Set(data.achievements || []);
          this.lastSave = data.state?.lastSave;
        }
        const s = this.getState();
        if ((s.coins || 0) === 0 && (s.wheat || 0) === 0 && Object.keys(this.purchased).length === 0) {
          this.state.coins = 15;
        }
      } catch(e) {}
    },

    syncCloud() {
      if (!FIREBASE_URL || /^anon_/.test(this.userId)) return;
      const score = Math.floor(this.getState().coins || 0);
      const payload = {
        userName: this.userName,
        cookies: score,
        updatedAt: Date.now(),
        save: {
          state: this.state,
          purchased: this.purchased,
          boughtUpgrades: [...this.boughtUpgrades],
          achievements: [...this.achievements],
          lastSave: this.state.lastSave || Date.now()
        }
      };
      fetch(`${FIREBASE_URL}/players/${this.userId}.json`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(() => {});
    },

    loadFromCloud() {
      if (!FIREBASE_URL || /^anon_/.test(this.userId)) return Promise.resolve();
      return fetch(`${FIREBASE_URL}/players/${this.userId}.json`)
        .then(r => r.json())
        .then(data => {
          if (!data || !data.save) return;
          const cloud = data.save;
          const cloudTime = cloud.lastSave || 0;
          const localTime = this.lastSave || 0;
          if (cloudTime >= localTime) {
            this.state = cloud.state || {};
            this.purchased = cloud.purchased || {};
            this.boughtUpgrades = new Set(cloud.boughtUpgrades || []);
            this.achievements = new Set(cloud.achievements || []);
            this.lastSave = cloud.lastSave;
            try {
              const toStore = { state: this.state, purchased: this.purchased, boughtUpgrades: [...this.boughtUpgrades], achievements: [...this.achievements] };
              localStorage.setItem(LS_KEY, JSON.stringify(toStore));
            } catch(e) {}
          }
        })
        .catch(() => {});
    },

    loadMarket() {
      const marketEl = document.getElementById('market-list');
      const myEl = document.getElementById('my-offers-list');
      if (!FIREBASE_URL || !marketEl) return;
      if (/^anon_/.test(this.userId)) {
        marketEl.innerHTML = '<p style="opacity:0.8;font-size:0.9rem;">–£–≤—ñ–π–¥–∏ —á–µ—Ä–µ–∑ Telegram, —â–æ–± —Ç–æ—Ä–≥—É–≤–∞—Ç–∏ –∑ —ñ–Ω—à–∏–º–∏ –≥—Ä–∞–≤—Ü—è–º–∏.</p>';
        if (myEl) myEl.innerHTML = '';
        const formEl = document.getElementById('create-offer-form');
        if (formEl) formEl.innerHTML = '';
        return;
      }
      marketEl.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      fetch(`${FIREBASE_URL}/market.json`).then(r => {
        if (!r.ok) throw new Error('–°–µ—Ä–≤–µ—Ä: ' + r.status);
        return r.json();
      }).then(data => {
        const raw = (data && typeof data === 'object' && !Array.isArray(data))
          ? Object.entries(data).map(([id, o]) => ({ id, ...(o || {}) }))
          : [];
        const offers = raw.filter(o => o && o.give && o.get && typeof o.give === 'object' && typeof o.get === 'object' && Object.keys(o.give).length > 0 && Object.keys(o.get).length > 0);
        const others = offers.filter(o => o.fromUserId !== this.userId);
        const mine = offers.filter(o => o.fromUserId === this.userId);
        marketEl.innerHTML = others.length === 0
          ? '<p style="opacity:0.7;font-size:0.85rem;">–ü–æ–∫–∏ –Ω–µ–º–∞—î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π. –í–∏—Å—Ç–∞–≤ —Å–≤–æ—é!</p>'
          : others.map(o => {
              const giveStr = Object.entries(o.give || {}).map(([r, a]) => format(a) + ' ' + (RESOURCES[r]?.icon || r)).join(', ');
              const getStr = Object.entries(o.get || {}).map(([r, a]) => format(a) + ' ' + (RESOURCES[r]?.icon || r)).join(', ');
              let can = true;
              for (const [res, amt] of Object.entries(o.get || {})) { if ((this.getState()[res] || 0) < amt) can = false; }
              const safeId = (o.id || '').replace(/'/g, "\\'");
              return `<div class="trade-row"><span class="trade-desc">${(o.fromUserName || '–ì—Ä–∞–≤–µ—Ü—å').replace(/</g, '&lt;')}: –≤—ñ–¥–¥–∞—î ${giveStr} ‚Üí —Ö–æ—á–µ ${getStr}</span><button class="btn-buy" ${!can ? 'disabled' : ''} onclick="Game.acceptOffer('${safeId}')">–ü—Ä–∏–π–Ω—è—Ç–∏</button></div>`;
            }).join('');
        myEl.innerHTML = mine.length === 0
          ? '<p style="opacity:0.7;font-size:0.85rem;">–¢–≤–æ—ó—Ö –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π –Ω–µ–º–∞—î.</p>'
          : mine.map(o => {
              const giveStr = Object.entries(o.give || {}).map(([r, a]) => format(a) + ' ' + (RESOURCES[r]?.icon || r)).join(', ');
              const getStr = Object.entries(o.get || {}).map(([r, a]) => format(a) + ' ' + (RESOURCES[r]?.icon || r)).join(', ');
              const safeId = (o.id || '').replace(/'/g, "\\'");
              return `<div class="trade-row"><span class="trade-desc">${giveStr} ‚Üí ${getStr}</span><button class="btn-buy" onclick="Game.cancelOffer('${safeId}')">–ó–Ω—è—Ç–∏</button></div>`;
            }).join('');
        const formEl = document.getElementById('create-offer-form');
        if (formEl) {
          const opts = TRADE_RESOURCES.map(r => `<option value="${r}">${RESOURCES[r]?.icon || ''} ${RESOURCES[r]?.name || r}</option>`).join('');
          formEl.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px;">
            <span>–í—ñ–¥–¥–∞—é:</span><select id="offer-give-res">${opts}</select><input type="number" id="offer-give-amt" min="1" value="100" style="width:70px">
            <span>‚Üí –•–æ—á—É:</span><select id="offer-get-res">${opts}</select><input type="number" id="offer-get-amt" min="1" value="50" style="width:70px">
            </div>
            <button class="btn-buy" onclick="Game.createMarketOffer(document.getElementById('offer-give-res').value, document.getElementById('offer-give-amt').value, document.getElementById('offer-get-res').value, document.getElementById('offer-get-amt').value)">–í–∏—Å—Ç–∞–≤–∏—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é</button>`;
        }
      }).catch(e => { marketEl.innerHTML = '–ü–æ–º–∏–ª–∫–∞: ' + (e.message || '–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'); });
    },

    createMarketOffer(giveRes, giveAmt, getRes, getAmt) {
      const s = this.getState();
      giveAmt = Math.floor(+giveAmt); getAmt = Math.floor(+getAmt);
      if (giveAmt < 1 || getAmt < 1) { alert('–ú—ñ–Ω—ñ–º—É–º 1'); return; }
      if ((s[giveRes] || 0) < giveAmt) { alert('–ù–µ –≤–∏—Å—Ç–∞—á–∞—î —Ä–µ—Å—É—Ä—Å—É'); return; }
      if (giveRes === getRes) { alert('–û–±–µ—Ä–∏ —Ä—ñ–∑–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏'); return; }
      this.spend(giveRes, giveAmt);
      const offerId = 'o' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
      const payload = { fromUserId: this.userId, fromUserName: this.userName, give: { [giveRes]: giveAmt }, get: { [getRes]: getAmt }, createdAt: Date.now() };
      const url = `${FIREBASE_URL}/market/${encodeURIComponent(offerId)}.json`;
      fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(r => {
          if (!r.ok) throw new Error(r.status + '');
          this.save();
          this.render();
          this.loadMarket();
        })
        .catch(e => {
          this.add(giveRes, giveAmt);
          alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏—Å—Ç–∞–≤–∏—Ç–∏. –ü–µ—Ä–µ–≤—ñ—Ä –ø—Ä–∞–≤–∏–ª–∞ Firebase –¥–ª—è /market (—á–∏—Ç–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø–∏—Å). –ü–æ–º–∏–ª–∫–∞: ' + (e.message || '–º–µ—Ä–µ–∂–∞'));
        });
    },

    acceptOffer(offerId) {
      if (!FIREBASE_URL || !offerId) return;
      const url = `${FIREBASE_URL}/market/${encodeURIComponent(offerId)}.json`;
      fetch(url).then(r => r.json()).then(offer => {
        if (!offer || offer.fromUserId === this.userId) return;
        const getRes = Object.keys(offer.get || {})[0], getAmt = offer.get[getRes];
        const giveRes = Object.keys(offer.give || {})[0], giveAmt = offer.give[giveRes];
        const myState = this.getState();
        if ((myState[getRes] || 0) < getAmt) { alert('–ù–µ –≤–∏—Å—Ç–∞—á–∞—î —Ä–µ—Å—É—Ä—Å—ñ–≤'); return; }
        fetch(`${FIREBASE_URL}/market/${encodeURIComponent(offerId)}.json`, { method: 'DELETE' }).then(() => {
          this.spend(getRes, getAmt);
          this.add(giveRes, giveAmt);
          const ownerId = offer.fromUserId;
          fetch(`${FIREBASE_URL}/players/${ownerId}/save.json`).then(r => r.json()).then(save => {
            if (!save) return;
            const state = save.state || {};
            state[getRes] = (state[getRes] || 0) + getAmt;
            save.state = state;
            fetch(`${FIREBASE_URL}/players/${ownerId}/save.json`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(save) }).catch(() => {});
          }).catch(() => {});
          this.save();
          this.render();
          this.loadMarket();
          alert('–£–≥–æ–¥—É –ø—Ä–∏–π–Ω—è—Ç–æ!');
        });
      });
    },

    cancelOffer(offerId) {
      if (!FIREBASE_URL || !offerId) return;
      const url = `${FIREBASE_URL}/market/${encodeURIComponent(offerId)}.json`;
      fetch(url).then(r => r.json()).then(offer => {
        if (!offer || offer.fromUserId !== this.userId) return;
        const give = offer.give || {};
        for (const [res, amt] of Object.entries(give)) this.add(res, amt);
        fetch(url, { method: 'DELETE' }).then(() => {
          this.save();
          this.render();
          this.loadMarket();
        });
      });
    },

    createGift(resource, amount) {
      const s = this.getState();
      if ((s[resource] || 0) < amount) return;
      this.spend(resource, amount);
      const code = 'g' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
      const payload = { fromUserId: this.userId, fromUserName: this.userName, resource, amount, createdAt: Date.now() };
      fetch(`${FIREBASE_URL}/gifts/${code}.json`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(() => {});
      this.save();
      this.render();
      const link = BOT_USERNAME && BOT_USERNAME !== 'YOUR_BOT_USERNAME' ? `https://t.me/${BOT_USERNAME}?start=gift_${code}` : '(–í–∫–∞–∂–∏ BOT_USERNAME –≤ –∫–æ–¥—ñ)';
      alert('–ü–æ–¥–∞—Ä—É–Ω–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ! –ü–æ–¥—ñ–ª–∏—Å—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º:\n' + link);
    },

    claimGift(code) {
      if (!FIREBASE_URL || !code) return Promise.resolve();
      return fetch(`${FIREBASE_URL}/gifts/${code}.json`).then(r => r.json()).then(data => {
        if (!data || data.claimedBy) return;
        this.add(data.resource, data.amount);
        fetch(`${FIREBASE_URL}/gifts/${code}/claimedBy.json`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.userId) }).catch(() => {});
        const fromId = data.fromUserId;
        if (fromId && fromId !== this.userId) {
          fetch(`${FIREBASE_URL}/friends/${this.userId}/${fromId}.json`, { method: 'PUT', body: 'true' }).catch(() => {});
          fetch(`${FIREBASE_URL}/friends/${fromId}/${this.userId}.json`, { method: 'PUT', body: 'true' }).catch(() => {});
        }
        this.save();
        if (data.fromUserName) alert('–ü–æ–¥–∞—Ä—É–Ω–æ–∫ –≤—ñ–¥ ' + data.fromUserName + ': +' + data.amount + ' ' + (RESOURCES[data.resource]?.name || data.resource));
      }).catch(() => {});
    },

    applyBoostsFromCloud() {
      if (!FIREBASE_URL || /^anon_/.test(this.userId)) return Promise.resolve();
      return fetch(`${FIREBASE_URL}/boosts/${this.userId}.json`).then(r => r.json()).then(data => {
        if (!data || !data.expiresAt || data.expiresAt <= Date.now()) return;
        this.state.boostActiveUntil = data.expiresAt;
        this.state.boostMultiplier = 2;
        fetch(`${FIREBASE_URL}/boosts/${this.userId}.json`, { method: 'DELETE' }).catch(() => {});
        this.save();
      }).catch(() => {});
    },

    giveBoostToFriend(friendId) {
      if (!FIREBASE_URL || /^anon_/.test(this.userId)) return;
      fetch(`${FIREBASE_URL}/lastBoostGiven/${this.userId}/${friendId}.json`).then(r => r.json()).then(last => {
        if (last && (Date.now() - last) < BOOST_COOLDOWN_MS) {
          alert('–ë—É—Å—Ç —Ü—å–æ–º—É –¥—Ä—É–≥—É –≤–∂–µ –¥–∞–≤–∞–ª–∏ —Å—å–æ–≥–æ–¥–Ω—ñ. –†–∞–∑ –Ω–∞ –¥–µ–Ω—å.');
          return;
        }
        const expiresAt = Date.now() + BOOST_DURATION_MS;
        const payload = { fromUserId: this.userId, fromUserName: this.userName, expiresAt, givenAt: Date.now() };
        fetch(`${FIREBASE_URL}/boosts/${friendId}.json`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(() => {
          fetch(`${FIREBASE_URL}/lastBoostGiven/${this.userId}/${friendId}.json`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(Date.now()) }).catch(() => {});
          alert('–ë—É—Å—Ç √ó2 –Ω–∞ 30 —Ö–≤ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –¥—Ä—É–≥—É!');
        });
      });
    },

    openPlayerInTG(uid) {
      if (!uid || /^anon_/.test(uid)) return;
      try {
        const link = 'tg://user?id=' + uid;
        if (window.Telegram?.WebApp?.openTelegramLink) {
          window.Telegram.WebApp.openTelegramLink(link);
        } else {
          window.open(link, '_blank');
        }
      } catch(e) {}
    },

    loadLeaderboard() {
      const el = document.getElementById('lb-global');
      if (!FIREBASE_URL) { el.innerHTML = '–î–æ–¥–∞–π FIREBASE_URL'; return; }
      el.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      fetch(`${FIREBASE_URL}/players.json`)
        .then(r => r.json())
        .then(data => {
          if (!data) { el.innerHTML = '–ù—ñ—Ö—Ç–æ —â–µ –Ω–µ –≥—Ä–∞–≤'; return; }
          const players = Object.entries(data).map(([uid, v]) => ({ uid, ...v }));
          players.sort((a, b) => (b.cookies || 0) - (a.cookies || 0));
          const rankEmoji = ['ü•á', 'ü•à', 'ü•â'];
          el.innerHTML = players.slice(0, 10).map((p, i) => {
            const isMe = p.uid === this.userId;
            const rk = i < 3 ? rankEmoji[i] : '#' + (i + 1);
            const tgClass = /^anon_/.test(p.uid) ? '' : ' lb-row-tg';
            const openTg = /^anon_/.test(p.uid) ? '' : ` onclick="Game.openPlayerInTG('${String(p.uid).replace(/'/g, "\\'")}')"`;
            return `<div class="lb-row${isMe ? ' me' : ''}${tgClass}"${openTg}>${rk}<span class="lb-name">${(p.userName || '–ì—Ä–∞–≤–µ—Ü—å').replace(/</g, '&lt;')}</span><span class="lb-score">${format(p.cookies || 0)} ü™ô</span><span class="lb-open">üë§</span></div>`;
          }).join('');
        })
        .catch(() => { el.innerHTML = '–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏'; });
    },

    startLoop() {
      const loop = (t) => {
        const dt = (t - (this._lastTick || t)) / 1000;
        this._lastTick = t;
        if (dt > 0 && dt < 1) this.tick(dt);
        this.checkAchievements();
        this.render();
        this._raf = requestAnimationFrame(loop);
      };
      this._raf = requestAnimationFrame(loop);
    },

    switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelector(`.tab[onclick*="'${tab}'"]`)?.classList.add('active');
      const v = document.getElementById('view-' + tab);
      if (v) v.classList.add('active');
      document.querySelector('.clicker-wrap').style.display = tab === 'main' ? 'flex' : 'none';
      if (tab === 'leaderboard') this.loadLeaderboard();
      if (tab === 'gifts') this.renderFriends();
      if (tab === 'trade') this.loadMarket();
    },

    render() {
      const s = this.getState();
      const cps = this.calcCPS();

      const statsHtml = ['wheat', 'flour', 'sugar', 'water', 'eggs', 'butter', 'dough', 'bread', 'cookies', 'buns', 'pies', 'cake', 'coins']
        .map(r => {
          const res = RESOURCES[r] || { name: r, icon: 'üì¶' };
          const cap = r !== 'coins' ? this.getStorageCap(r) : null;
          const capStr = cap != null && cap < 1e8 ? ` / ${format(cap)}` : '';
          let cpsVal = (cps[r] || 0);
          if ((s.boostActiveUntil || 0) > Date.now() && (s.boostMultiplier || 1) > 1) cpsVal *= s.boostMultiplier;
          const boostTag = (s.boostActiveUntil || 0) > Date.now() ? ' √ó2' : '';
          const cpsStr = cpsVal >= 0 ? `+${cpsVal.toFixed(1)}/—Å` : `${cpsVal.toFixed(1)}/—Å`;
          return `<div class="stat"><div class="stat-val">${format(s[r] || 0)}${capStr}</div>${res.icon} ${res.name}<div class="stat-cps" style="${cpsVal < 0 ? 'color:var(--accent)' : ''}">${cpsStr}${boostTag}</div></div>`;
        }).join('');
      document.getElementById('stats-panel').innerHTML = statsHtml || '<div class="stat" style="grid-column:1/-1">–ö–ª—ñ–∫–∞–π –ø—à–µ–Ω–∏—Ü—é ‚Äî –∑–±–∏—Ä–∞–π —É—Ä–æ–∂–∞–π</div>';
      const titleEl = document.getElementById('app-title');
      if (titleEl) titleEl.textContent = (s.bakeryName ? s.bakeryName + ' üçû' : 'üçû –ü–µ–∫–∞—Ä–Ω—è');
      const clickPctEl = document.getElementById('click-percent');
      if (clickPctEl) clickPctEl.textContent = '–ö–ª—ñ–∫: ' + (s.clickBonusPercent || 10) + '%';
      if ((s.boostActiveUntil || 0) <= Date.now()) { this.state.boostMultiplier = 1; this.state.boostActiveUntil = 0; }
      const toFull = this.getTimeToFullStorage();
      const timerEl = document.getElementById('storage-timer');
      if (timerEl) {
        if (toFull) {
          timerEl.textContent = `–°–∫–ª–∞–¥ –∑–∞–ø–æ–≤–Ω–∏—Ç—å—Å—è (${toFull.icon} ${toFull.name}): —á–µ—Ä–µ–∑ ${this.formatTime(toFull.sec)}`;
          timerEl.style.display = 'block';
        } else {
          timerEl.style.display = 'none';
        }
      }

      document.getElementById('buildings-list').innerHTML = BUILDINGS.map(b => {
        const cost = this.getCost(b);
        const canBuy = this.canAfford(b.costRes, cost);
        const count = this.getCount(b.id);
        const res = RESOURCES[b.resource];
        const stats = b.isStorage
          ? `–ú—ñ—Å—Ü–µ: +${(STORAGE_PER_LEVEL.wheat || 500)}/—Ä—ñ–≤–µ–Ω—å –Ω–∞ —Ä–µ—Å—É—Ä—Å`
          : `+${b.prod} ${res?.icon || ''}/—Å`;
        return `<div class="building">
          <div class="building-info">
            <div class="building-name">${b.name} √ó ${count}</div>
            <div class="building-desc">${b.desc}</div>
            <div class="building-stats">${stats}</div>
          </div>
          <button class="btn-buy" ${!canBuy ? 'disabled' : ''} onclick="Game.buyBuilding(BUILDINGS_DATA[${BUILDINGS.indexOf(b)}])">${format(cost)} ${(RESOURCES[b.costRes] || { icon: 'ü™ô' }).icon}</button>
        </div>`;
      }).join('');

      document.getElementById('upgrades-list').innerHTML = UPGRADES.map(u => {
        const bought = this.boughtUpgrades.has(u.id);
        const canBuy = !bought && this.canAfford(u.costRes, u.cost);
        return `<div class="upgrade-item">
          <div class="upgrade-info">
            <div class="upgrade-name">${u.name} ${bought ? '‚úì' : ''}</div>
            <div class="upgrade-desc">${u.desc}</div>
          </div>
          <button class="btn-buy" ${!canBuy ? 'disabled' : ''} onclick="Game.buyUpgrade(UPGRADES_DATA[${UPGRADES.indexOf(u)}])">${bought ? '–ö—É–ø–ª–µ–Ω–æ' : format(u.cost) + ' ' + (RESOURCES[u.costRes] || { icon: 'ü™ô' }).icon}</button>
        </div>`;
      }).join('');

      document.getElementById('achievements-list').innerHTML = ACHIEVEMENTS.map(a => {
        const un = this.achievements.has(a.id);
        return `<div class="achieve-item ${un ? 'unlocked' : ''}"><span class="badge">${a.icon}</span><div><div class="upgrade-name">${a.name}</div><div class="upgrade-desc">${a.desc}</div></div>${un ? '‚úÖ' : 'üîí'}</div>`;
      }).join('');

      const giftForm = document.getElementById('gift-form');
      if (giftForm) {
        const opts = ['wheat', 'flour', 'bread', 'coins'].map(r => `<option value="${r}">${RESOURCES[r]?.icon || ''} ${RESOURCES[r]?.name || r}</option>`).join('');
        giftForm.innerHTML = `<select id="gift-res">${opts}</select><input type="number" id="gift-amt" min="1" value="50" style="width:80px"> <button class="btn-buy" onclick="Game.createGift(document.getElementById('gift-res').value, +document.getElementById('gift-amt').value)">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>`;
      }
    },

    renderFriends() {
      const el = document.getElementById('friends-list');
      if (!el || !FIREBASE_URL || /^anon_/.test(this.userId)) { if (el) el.innerHTML = '<p style="opacity:0.7;font-size:0.85rem;">–£–≤—ñ–π–¥–∏ —á–µ—Ä–µ–∑ Telegram —ñ –æ–±–º—ñ–Ω—è–π—Å—è –ø–æ–¥–∞—Ä—É–Ω–∫–∞–º–∏ ‚Äî –¥—Ä—É–∑—ñ –∑\'—è–≤–ª—è—Ç—å—Å—è —Ç—É—Ç.</p>'; return; }
      el.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      fetch(`${FIREBASE_URL}/friends/${this.userId}.json`).then(r => r.json()).then(friends => {
        if (!friends || typeof friends !== 'object') { el.innerHTML = '<p style="opacity:0.7;font-size:0.85rem;">–ü–æ–∫–∏ –Ω–µ–º–∞—î –¥—Ä—É–∑—ñ–≤. –ù–∞–¥—ñ—à–ª–∏ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ ‚Äî —Ö—Ç–æ –æ—Ç—Ä–∏–º–∞—î, —Å—Ç–∞–Ω–µ –¥—Ä—É–≥–æ–º.</p>'; return; }
        const ids = Object.keys(friends);
        if (ids.length === 0) { el.innerHTML = '<p style="opacity:0.7;font-size:0.85rem;">–ü–æ–∫–∏ –Ω–µ–º–∞—î –¥—Ä—É–∑—ñ–≤.</p>'; return; }
        Promise.all(ids.map(uid => fetch(`${FIREBASE_URL}/players/${uid}.json`).then(r => r.json()).then(p => ({ uid, name: p?.userName || '–ì—Ä–∞–≤–µ—Ü—å' })))).then(arr => {
          el.innerHTML = arr.map(({ uid, name }) => `<div class="friend-row"><span>${(name || '–ì—Ä–∞–≤–µ—Ü—å').replace(/</g, '&lt;')}</span><button class="btn-buy" onclick="Game.giveBoostToFriend('${uid}')">–î–∞—Ç–∏ –±—É—Å—Ç √ó2</button></div>`).join('');
        });
      }).catch(() => { el.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'; });
    }
  };

  window.BUILDINGS_DATA = BUILDINGS;
  window.UPGRADES_DATA = UPGRADES;
  window.Game = Game;
  Game.init();
})();
</script>
</body>
</html>
