<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grow Your Dick</title>
<script src="https://telegram.org/js/telegram-web-app.js" async></script>
<style>
  /* â”€â”€ FIREBASE CONFIG â”€â”€ replace with your own â”€â”€ */
  :root {
    --bg: #87CEEB;
    --grass: #4CAF50;
    --text: #1a1a2e;
    --card: rgba(255,255,255,0.85);
    --card-border: rgba(255,255,255,0.5);
    --btn-water: #2196F3;
    --btn-shave: #9C27B0;
    --btn-lb: #FF9800;
    --disabled: #aaa;
    --shadow: rgba(0,0,0,0.15);
    --sun: #FFD700;
    --accent: #FF6B35;
  }
  [data-theme="dark"] {
    --bg: #1a1a2e;
    --grass: #2d5a27;
    --text: #e0e0e0;
    --card: rgba(30,30,50,0.9);
    --card-border: rgba(80,80,120,0.5);
    --btn-water: #1565C0;
    --btn-shave: #6A1B9A;
    --btn-lb: #E65100;
    --disabled: #555;
    --shadow: rgba(0,0,0,0.5);
    --sun: #FFA500;
    --accent: #FF6B35;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.3s, color 0.3s;
  }
  #app { display: flex; flex-direction: column; min-height: 100vh; }

  /* â”€â”€ HEADER â”€â”€ */
  #header {
    text-align: center;
    padding: 12px 16px 8px;
    position: relative;
    z-index: 10;
  }
  #header h1 {
    font-size: 1.5rem;
    font-weight: 900;
    letter-spacing: -0.5px;
    text-shadow: 0 2px 4px var(--shadow);
    background: linear-gradient(135deg, #FF6B35, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  #size-display {
    font-size: 1.1rem;
    font-weight: 700;
    margin-top: 4px;
    color: var(--text);
  }
  #size-display span { color: var(--accent); font-size: 1.3rem; transition: transform 0.15s ease-out; }
  #size-display span.grow-pop { animation: growPop 0.4s ease-out; }
  @keyframes growPop { 0% { transform: scale(1); } 40% { transform: scale(1.25); } 100% { transform: scale(1); } }
  #status-text {
    font-size: 0.8rem;
    opacity: 0.7;
    margin-top: 2px;
    min-height: 18px;
    font-style: italic;
  }

  /* â”€â”€ TABS â”€â”€ */
  #tabs {
    display: flex;
    margin: 0 16px 8px;
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    overflow: hidden;
    backdrop-filter: blur(10px);
  }
  .tab-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background: transparent;
    color: var(--text);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    opacity: 0.6;
  }
  .tab-btn.active {
    background: var(--accent);
    color: white;
    opacity: 1;
    border-radius: 10px;
  }

  /* â”€â”€ GAME VIEW â”€â”€ */
  #game-view { flex: 1; display: flex; flex-direction: column; }
  #canvas-wrap {
    flex: 1;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 0 20px;
    min-height: 220px;
    position: relative;
  }
  canvas#gameCanvas {
    display: block;
    max-width: 100%;
  }

  /* â”€â”€ MILESTONE TOAST â”€â”€ */
  #milestone-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: linear-gradient(135deg, #FF6B35, #FFD700);
    color: white;
    padding: 16px 28px;
    border-radius: 20px;
    font-size: 1.2rem;
    font-weight: 900;
    text-align: center;
    z-index: 999;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
    pointer-events: none;
  }
  #milestone-toast.show { transform: translate(-50%, -50%) scale(1); }

  /* â”€â”€ CONTROLS â”€â”€ */
  #controls {
    padding: 8px 16px 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .action-row { display: flex; gap: 8px; }
  .action-btn {
    flex: 1;
    padding: 12px 8px;
    border: none;
    border-radius: 14px;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 12px var(--shadow);
    color: white;
    line-height: 1.3;
  }
  .action-btn:active:not(:disabled) { transform: scale(0.96); }
  .action-btn:disabled {
    background: var(--disabled) !important;
    cursor: not-allowed;
    box-shadow: none;
    opacity: 0.7;
  }
  #btn-water { background: linear-gradient(135deg, #2196F3, #0D47A1); }
  #btn-shave { background: linear-gradient(135deg, #9C27B0, #4A148C); }
  #btn-share {
    width: 100%;
    background: linear-gradient(135deg, #FF6B35, #e91e63);
    padding: 13px;
    font-size: 1rem;
  }

  /* â”€â”€ LEADERBOARD â”€â”€ */
  #lb-view { padding: 8px 16px 16px; display: none; flex-direction: column; gap: 10px; }
  #lb-view.active { display: flex; }
  #lb-title {
    text-align: center;
    font-size: 1.2rem;
    font-weight: 900;
    background: linear-gradient(135deg, #FF6B35, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  #lb-list {
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    overflow: hidden;
    backdrop-filter: blur(10px);
  }
  .lb-row {
    display: flex;
    align-items: center;
    padding: 10px 14px;
    border-bottom: 1px solid var(--card-border);
    gap: 10px;
    transition: background 0.2s;
  }
  .lb-row:last-child { border-bottom: none; }
  .lb-row.me { background: rgba(255,107,53,0.15); }
  .lb-rank {
    font-size: 1.1rem;
    font-weight: 900;
    width: 28px;
    text-align: center;
    flex-shrink: 0;
  }
  .lb-rank.gold { color: #FFD700; }
  .lb-rank.silver { color: #C0C0C0; }
  .lb-rank.bronze { color: #CD7F32; }
  .lb-name { flex: 1; font-weight: 600; font-size: 0.9rem; }
  .lb-length { font-weight: 800; color: var(--accent); font-size: 0.95rem; }
  .lb-updated { font-size: 0.7rem; opacity: 0.5; }
  #lb-refresh-btn {
    background: var(--btn-lb);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 10px;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 12px var(--shadow);
    transition: transform 0.1s;
  }
  #lb-refresh-btn:active { transform: scale(0.97); }
  #lb-empty { text-align: center; padding: 20px; opacity: 0.5; font-size: 0.9rem; }

  /* â”€â”€ PROGRESS BAR â”€â”€ */
  #progress-wrap {
    margin: 0 16px 4px;
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    height: 12px;
    overflow: hidden;
    backdrop-filter: blur(6px);
  }
  #progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #FF6B35, #FFD700, #4CAF50);
    border-radius: 20px;
    transition: width 0.5s ease-out;
    min-width: 2px;
  }

  /* â”€â”€ BOOST INDICATOR â”€â”€ */
  #boost-bar {
    margin: 0 16px 6px;
    display: flex;
    gap: 6px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .boost-pill {
    padding: 3px 10px;
    border-radius: 20px;
    opacity: 0;
    transition: opacity 0.3s;
    background: var(--card);
    border: 1px solid var(--card-border);
  }
  .boost-pill.active { opacity: 1; }
  #boost-water.active { background: rgba(33,150,243,0.3); color: #2196F3; }
  #boost-shave.active { background: rgba(156,39,176,0.3); color: #9C27B0; }

  /* confetti canvas */
  #confetti-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 998;
  }

  /* Loading */
  #loading {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    flex-direction: column;
    gap: 12px;
    font-size: 1.1rem;
    font-weight: 700;
  }
  .spinner {
    width: 40px; height: 40px;
    border: 4px solid var(--card-border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <span>Loading your garden... ğŸŒ±</span>
</div>

<canvas id="confetti-canvas"></canvas>
<div id="milestone-toast">ğŸ‰ Milestone!</div>

<div id="app">
  <div id="header">
    <h1>ğŸŒ± Grow Your Dick</h1>
    <div id="size-display">Your Dick: <span id="length-val">0.0</span> cm</div>
    <div id="status-text">Loading...</div>
  </div>

  <div id="tabs">
    <button class="tab-btn active" onclick="switchTab('game')" id="tab-game">ğŸ® Game</button>
    <button class="tab-btn" onclick="switchTab('lb')" id="tab-lb">ğŸ† Leaderboard</button>
  </div>

  <!-- GAME TAB -->
  <div id="game-view">
    <div id="progress-wrap"><div id="progress-bar" style="width:0%"></div></div>
    <div id="boost-bar">
      <div class="boost-pill" id="boost-water">ğŸ’§ Watered Ã—3</div>
      <div class="boost-pill" id="boost-shave">âœ‚ï¸ Shaved Ã—2.5</div>
    </div>
    <div id="canvas-wrap">
      <canvas id="gameCanvas"></canvas>
    </div>
    <div id="controls">
      <div class="action-row">
        <button class="action-btn" id="btn-water" onclick="doWater()">ğŸ’§ Water<br><small id="water-cd">Ready!</small></button>
        <button class="action-btn" id="btn-shave" onclick="doShave()">âœ‚ï¸ Shave<br><small id="shave-cd">Ready!</small></button>
      </div>
      <button class="action-btn" id="btn-share" onclick="doShare()">ğŸ”¥ Share<br><small id="share-cd">Ready!</small></button>
    </div>
  </div>

  <!-- LEADERBOARD TAB -->
  <div id="lb-view">
    <div id="lb-title">ğŸ† Global Leaderboard</div>
    <div id="lb-list"><div id="lb-empty">Loading leaderboard...</div></div>
    <button id="lb-refresh-btn" onclick="loadLeaderboard()">ğŸ”„ Refresh</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE CONFIG â€” replace with your own values
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT"
};
const FIREBASE_ENABLED = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASE_GROWTH_PER_HOUR = 2.88;
const MAX_LENGTH = 200;
const WATER_COOLDOWN = 4 * 3600 * 1000;
const SHAVE_COOLDOWN = 30 * 60 * 1000;
const SHARE_COOLDOWN = 60 * 1000; // 1 min
const WATER_BONUS = 8;
const SHAVE_BONUS = 3;
const WATER_MULTIPLIER = 3;
const SHAVE_MULTIPLIER = 2.5;
const WATER_BOOST_DURATION = 4 * 3600 * 1000;
const SHAVE_BOOST_DURATION = 2 * 3600 * 1000;
const MAX_OFFLINE_HOURS = 24;
const MILESTONES = [10, 25, 50, 69, 100, 150, 200];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  length: 1.0,
  lastSaved: Date.now(),
  lastWater: 0,
  lastShave: 0,
  lastShare: 0,
  waterBoostUntil: 0,
  shaveBoostUntil: 0,
  milestonesReached: []
};
let displayLength = 1.0;   // smoothed value for animation
let growthBurst = 0;       // 0..1, pulse when growing
let userId = 'anon';
let userName = 'Anonymous';
let tg = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TELEGRAM INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTelegram() {
  try {
    tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      const cs = tg.colorScheme || 'light';
      document.documentElement.setAttribute('data-theme', cs);
      const user = tg.initDataUnsafe?.user;
      if (user) {
        userId = String(user.id);
        const last = user.last_name ? user.last_name[0] + '.' : '';
        userName = (user.first_name || 'Player') + (last ? ' ' + last : '');
      }
      try {
        if (tg.MainButton) {
          tg.MainButton.setText('Share My Size ğŸ”¥');
          tg.MainButton.onClick(doShare);
          tg.MainButton.show();
        }
      } catch(mb) {}
    } else {
      document.documentElement.setAttribute('data-theme', 'light');
    }
  } catch(e) { document.documentElement.setAttribute('data-theme', 'light'); }
}

function haptic(type, style) {
  try {
    if (tg?.HapticFeedback) {
      if (type === 'impact') tg.HapticFeedback.impactOccurred(style || 'medium');
      else if (type === 'notification') tg.HapticFeedback.notificationOccurred(style || 'success');
    } else if (navigator.vibrate) navigator.vibrate(type === 'error' ? [30,20,30] : [30]);
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE / LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS_KEY = 'gyd_save_v3';

function saveLocal() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }

function loadLocal() {
  try { const d = localStorage.getItem(LS_KEY); if (d) return JSON.parse(d); } catch(e) {}
  return null;
}

async function saveToFirebase(s) {
  if (!FIREBASE_ENABLED) return;
  try {
    await fetch(`${FIREBASE_CONFIG.databaseURL}/players/${userId}.json`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...s, userName, updatedAt: Date.now() })
    });
  } catch(e) { console.warn('Firebase save', e); }
}

async function loadLeaderboard() {
  document.getElementById('lb-empty').textContent = 'Loading...';
  if (!FIREBASE_ENABLED) {
    document.getElementById('lb-empty').textContent = 'âš ï¸ Enable Firebase for global leaderboard.';
    return;
  }
  try {
    const r = await fetch(`${FIREBASE_CONFIG.databaseURL}/players.json?orderBy="length"&limitToLast=50`);
    if (!r.ok) throw new Error('fetch failed');
    const data = await r.json();
    if (!data) { document.getElementById('lb-empty').textContent = 'No players yet!'; return; }
    let players = Object.entries(data).map(([uid, v]) => ({ uid, ...v }));
    players.sort((a,b) => (b.length||0) - (a.length||0));
    renderLeaderboard(players);
  } catch(e) { document.getElementById('lb-empty').textContent = 'Failed to load.'; }
}

function renderLeaderboard(players) {
  const el = document.getElementById('lb-list');
  if (!players.length) { el.innerHTML = '<div id="lb-empty">No one yet. Be first! ğŸ’ª</div>'; return; }
  const rankEmoji = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const rankClass = ['gold','silver','bronze'];
  el.innerHTML = players.slice(0,10).map((p, i) => {
    const isMe = p.uid === userId;
    const rk = i < 3 ? `<span class="lb-rank ${rankClass[i]}">${rankEmoji[i]}</span>` : `<span class="lb-rank">#${i+1}</span>`;
    const updated = p.updatedAt ? timeAgo(p.updatedAt) : '';
    return `<div class="lb-row${isMe?' me':''}">
      ${rk}<div class="lb-name">${escHtml(p.userName||'Player')}</div>
      <div><div class="lb-length">${(p.length||0).toFixed(1)} cm</div><div class="lb-updated">${updated}</div></div>
    </div>`;
  }).join('');
}

function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function timeAgo(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VALIDATION / OFFLINE GROWTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function validateState(s) {
  const now = Date.now();
  if (!s || typeof s.length !== 'number') return false;
  s.length = Math.max(0, Math.min(MAX_LENGTH, s.length));
  if (s.lastWater > now) s.lastWater = 0;
  if (s.lastShave > now) s.lastShave = 0;
  return true;
}

function applyOfflineGrowth() {
  const now = Date.now();
  const elapsed = Math.min(now - state.lastSaved, MAX_OFFLINE_HOURS * 3600 * 1000);
  if (elapsed <= 0) return;
  const hours = elapsed / 3600000;
  let mult = 1;
  if (state.waterBoostUntil > now) mult *= WATER_MULTIPLIER;
  if (state.shaveBoostUntil > now) mult *= SHAVE_MULTIPLIER;
  const growth = hours * BASE_GROWTH_PER_HOUR * mult;
  state.length = Math.min(MAX_LENGTH, state.length + growth);
  state.lastSaved = now;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let wobble = 0;

function resizeCanvas() {
  const wrap = document.getElementById('canvas-wrap');
  const W = Math.min(wrap.clientWidth, 360);
  const H = Math.min(wrap.clientHeight, 300);
  canvas.width = W;
  canvas.height = H;
}

function lerp(a, b, t) { return a + (b - a) * t; }

function drawCloud(ctx, x, y, r) {
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.beginPath();
  ctx.arc(x, y, r*0.6, 0, Math.PI*2);
  ctx.arc(x+r*0.8, y-r*0.2, r*0.7, 0, Math.PI*2);
  ctx.arc(x+r*1.2, y, r*0.5, 0, Math.PI*2);
  ctx.fill();
}

function drawScene(len, burst) {
  burst = burst || 0;
  const W = canvas.width, H = canvas.height;
  if (!W || !H) return;
  ctx.clearRect(0,0,W,H);
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

  const sky = ctx.createLinearGradient(0,0,0,H*0.75);
  if (isDark) { sky.addColorStop(0,'#0d1b2a'); sky.addColorStop(1,'#1a3a5c'); }
  else { sky.addColorStop(0,'#87CEEB'); sky.addColorStop(1,'#c8e8f8'); }
  ctx.fillStyle = sky;
  ctx.fillRect(0,0,W,H*0.75);

  ctx.beginPath();
  ctx.arc(W*0.82, H*0.15, 22, 0, Math.PI*2);
  ctx.fillStyle = isDark ? '#ffffcc' : '#FFD700';
  ctx.fill();

  if (!isDark) {
    drawCloud(ctx, W*0.15, H*0.12, 40);
    drawCloud(ctx, W*0.55, H*0.08, 30);
  }

  const grassGrad = ctx.createLinearGradient(0, H*0.72, 0, H);
  grassGrad.addColorStop(0, isDark ? '#2d5a27' : '#4CAF50');
  grassGrad.addColorStop(1, isDark ? '#1a3d15' : '#388E3C');
  ctx.fillStyle = grassGrad;
  ctx.beginPath();
  ctx.moveTo(0, H*0.75);
  for (let x=0; x<=W; x+=10) ctx.lineTo(x, H*0.75 + Math.sin(x*0.1)*3);
  ctx.lineTo(W, H); ctx.lineTo(0, H);
  ctx.fill();

  const cx = W / 2, baseY = H * 0.75 - 2;
  const maxH = H * 0.68, minH = 18;
  const t = Math.min(len / MAX_LENGTH, 1);
  const height = lerp(minH, maxH, t);
  const baseWidth = lerp(8, 28, t);
  const topY = baseY - height;
  const w = Math.sin(wobble) * Math.min(4, height * 0.06);
  wobble = wobble > 0 ? wobble - 0.12 : 0;

  // Growth burst: scale the dick upward (1 + burst * 0.3)
  const burstScale = 1 + burst * 0.3;
  ctx.save();
  ctx.translate(cx, baseY);
  ctx.scale(1, burstScale);
  ctx.translate(-cx, -baseY);

  if (ctx.ellipse) {
    ctx.beginPath();
    ctx.ellipse(cx + w*0.3, baseY + 6, baseWidth*0.9, 5, 0, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.fill();
  }

  const shaftGrad = ctx.createLinearGradient(cx - baseWidth, topY, cx + baseWidth, topY);
  shaftGrad.addColorStop(0, '#d4896b');
  shaftGrad.addColorStop(0.35, '#e8a882');
  shaftGrad.addColorStop(0.65, '#e8a882');
  shaftGrad.addColorStop(1, '#d4896b');
  ctx.fillStyle = shaftGrad;

  ctx.beginPath();
  ctx.moveTo(cx - baseWidth + w, baseY);
  ctx.quadraticCurveTo(cx - baseWidth*0.8 + w, topY + height*0.3, cx - baseWidth*0.5, topY + height*0.5);
  ctx.quadraticCurveTo(cx, topY + height*0.2, cx + baseWidth*0.5, topY + height*0.5);
  ctx.quadraticCurveTo(cx + baseWidth*0.8 - w, topY + height*0.3, cx + baseWidth - w, baseY);
  ctx.closePath();
  ctx.fill();

  ctx.strokeStyle = 'rgba(0,0,0,0.1)';
  ctx.lineWidth = 1;
  ctx.stroke();

  ctx.beginPath();
  ctx.ellipse(cx, topY, baseWidth*0.5, baseWidth*0.4, 0, 0, Math.PI*2);
  ctx.fillStyle = '#e8b090';
  ctx.fill();

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFETTI / MILESTONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confetti() {
  const c = document.getElementById('confetti-canvas');
  c.width = window.innerWidth;
  c.height = window.innerHeight;
  const ctx = c.getContext('2d');
  const particles = [];
  const colors = ['#FF6B35','#FFD700','#4CAF50','#2196F3','#9C27B0'];
  for (let i=0; i<60; i++) {
    particles.push({
      x: c.width/2, y: c.height/2,
      vx: (Math.random()-0.5)*12,
      vy: (Math.random()-0.5)*12 - 4,
      color: colors[Math.floor(Math.random()*colors.length)],
      size: Math.random()*8 + 4,
      life: 1
    });
  }
  function tick() {
    ctx.clearRect(0,0,c.width,c.height);
    let allDead = true;
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy; p.vy += 0.3; p.life -= 0.02;
      if (p.life > 0) { allDead = false; ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); }
    });
    ctx.globalAlpha = 1;
    if (!allDead) requestAnimationFrame(tick);
  }
  tick();
}

function showMilestone(text) {
  const el = document.getElementById('milestone-toast');
  el.textContent = 'ğŸ‰ ' + text + ' cm!';
  el.classList.add('show');
  confetti();
  haptic('notification', 'success');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function canWater() { return Date.now() - state.lastWater >= WATER_COOLDOWN; }
function canShave() { return Date.now() - state.lastShave >= SHAVE_COOLDOWN; }
function canShare() { return Date.now() - state.lastShare >= SHARE_COOLDOWN; }

function triggerGrowthAnimation() {
  growthBurst = 1;
  const el = document.getElementById('length-val');
  if (el) { el.classList.add('grow-pop'); setTimeout(() => el.classList.remove('grow-pop'), 450); }
}

function doWater() {
  if (!canWater()) { haptic('error'); return; }
  haptic('impact');
  state.length = Math.min(MAX_LENGTH, state.length + WATER_BONUS);
  state.lastWater = Date.now();
  state.waterBoostUntil = Date.now() + WATER_BOOST_DURATION;
  state.lastSaved = Date.now();
  wobble = 1.2;
  triggerGrowthAnimation();
  saveLocal();
  updateLeaderboard();
  updateUI();
  checkMilestones();
}

function doShave() {
  if (!canShave()) { haptic('error'); return; }
  haptic('impact');
  state.length = Math.min(MAX_LENGTH, state.length + SHAVE_BONUS);
  state.lastShave = Date.now();
  state.shaveBoostUntil = Date.now() + SHAVE_BOOST_DURATION;
  state.lastSaved = Date.now();
  wobble = 1.2;
  triggerGrowthAnimation();
  saveLocal();
  updateLeaderboard();
  updateUI();
  checkMilestones();
}

function checkMilestones() {
  MILESTONES.forEach(m => {
    if (state.length >= m && !state.milestonesReached.includes(m)) {
      state.milestonesReached.push(m);
      showMilestone(m + ' cm milestone!');
    }
  });
}

async function updateLeaderboard() { if (FIREBASE_ENABLED) await saveToFirebase(state); }

function doShare() {
  if (!canShare()) { haptic('error'); return; }
  haptic('impact');
  state.lastShare = Date.now();
  saveLocal();
  const msg = `ğŸ”¥ My dick is ${state.length.toFixed(1)} cm! Can you beat me? ğŸŒ±`;
  if (tg) {
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(location.href)}&text=${encodeURIComponent(msg)}`);
  } else if (navigator.share) {
    navigator.share({ title: 'Grow Your Dick', text: msg, url: location.href }).catch(() => {});
  } else {
    navigator.clipboard?.writeText(msg + ' ' + location.href);
    document.getElementById('status-text').textContent = 'Copied!';
    setTimeout(() => updateStatusText(), 2000);
  }
  updateUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatTime(ms) {
  const s = Math.ceil(ms / 1000);
  const m = Math.floor(s / 60), h = Math.floor(m / 60);
  if (h > 0) return h + 'h ' + (m % 60) + 'm';
  if (m > 0) return m + 'm ' + (s % 60) + 's';
  return s + 's';
}

function updateStatusText() {
  const el = document.getElementById('status-text');
  const now = Date.now();
  if (state.waterBoostUntil > now) el.textContent = 'ğŸ’§ Water boost active!';
  else if (state.shaveBoostUntil > now) el.textContent = 'âœ‚ï¸ Shave boost active!';
  else if (!canWater() || !canShave()) {
    const w = Math.max(0, WATER_COOLDOWN - (now - state.lastWater));
    const s = Math.max(0, SHAVE_COOLDOWN - (now - state.lastShave));
    if (w > 0 && s > 0) el.textContent = `Water: ${formatTime(w)} Â· Shave: ${formatTime(s)}`;
    else if (w > 0) el.textContent = 'Water: ' + formatTime(w);
    else el.textContent = 'Shave: ' + formatTime(s);
  } else el.textContent = 'Ready! Tap to grow ğŸŒ±';
}

function updateUI() {
  const lenEl = document.getElementById('length-val');
  lenEl.textContent = displayLength.toFixed(1);
  document.getElementById('progress-bar').style.width = Math.min(100, (displayLength / MAX_LENGTH) * 100) + '%';
  document.getElementById('boost-water').classList.toggle('active', state.waterBoostUntil > Date.now());
  document.getElementById('boost-shave').classList.toggle('active', state.shaveBoostUntil > Date.now());
  document.getElementById('btn-water').disabled = !canWater();
  document.getElementById('btn-shave').disabled = !canShave();
  document.getElementById('btn-share').disabled = !canShare();
  document.getElementById('water-cd').textContent = canWater() ? 'Ready!' : formatTime(Math.max(0, WATER_COOLDOWN - (Date.now() - state.lastWater)));
  document.getElementById('shave-cd').textContent = canShave() ? 'Ready!' : formatTime(Math.max(0, SHAVE_COOLDOWN - (Date.now() - state.lastShave)));
  document.getElementById('share-cd').textContent = canShare() ? 'Ready!' : formatTime(Math.max(0, SHARE_COOLDOWN - (Date.now() - state.lastShare)));
  updateStatusText();
  drawScene(displayLength, growthBurst);
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  document.getElementById('game-view').style.display = tab === 'game' ? 'flex' : 'none';
  document.getElementById('lb-view').classList.toggle('active', tab === 'lb');
  if (tab === 'lb') loadLeaderboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hideLoading() {
  const el = document.getElementById('loading');
  if (el && el.style.display !== 'none') el.style.display = 'none';
}

async function init() {
  // Safety: hide loading after 2.5s even if something hangs
  const safetyTimeout = setTimeout(hideLoading, 2500);

  // Wait for Telegram script (max 1.2s) â€” in Telegram client API may be injected
  for (let i = 0; i < 24; i++) {
    if (window.Telegram?.WebApp) break;
    await new Promise(r => setTimeout(r, 50));
  }

  initTelegram();
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const local = loadLocal();
  let remote = null;
  if (FIREBASE_ENABLED) {
    try {
      const r = await Promise.race([
        fetch(`${FIREBASE_CONFIG.databaseURL}/players/${userId}.json`),
        new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 3000))
      ]);
      if (r.ok) remote = await r.json();
    } catch(e) {}
  }

  clearTimeout(safetyTimeout);

  if (remote && validateState(remote)) {
    if (local && local.lastSaved > (remote.updatedAt || 0)) state = { ...state, ...local };
    else state = { ...state, ...remote, milestonesReached: local?.milestonesReached || [] };
  } else if (local && validateState(local)) {
    state = { ...state, ...local };
  }
  state.lastSaved = Date.now();
  applyOfflineGrowth();
  validateState(state);
  saveLocal();
  updateLeaderboard();

  displayLength = state.length;
  hideLoading();
  updateUI();
  let lastLen = state.length;
  setInterval(() => {
    applyOfflineGrowth();
    if (Math.abs(state.length - lastLen) > 0.01) { lastLen = state.length; saveLocal(); updateLeaderboard(); }
    updateUI();
  }, 2000);
  requestAnimationFrame(function loop() {
    displayLength = displayLength + (state.length - displayLength) * 0.12;
    if (Math.abs(displayLength - state.length) < 0.02) displayLength = state.length;
    growthBurst = Math.max(0, growthBurst - 0.03);
    updateUI();
    requestAnimationFrame(loop);
  });
}

init().catch(e => { document.getElementById('loading').innerHTML = 'Error: ' + e.message; });
</script>
</body>
</html>
