<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.MainButton.setText("–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å —á–ª–µ–Ω–æ–º üî•").show();

    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');

    let w = canvas.width = window.innerWidth;
    let h = canvas.height = window.innerHeight;

    // –î–∞–Ω—ñ –≥—Ä–∏
    let length = 5;
    let lastTime = Date.now();
    let waterCooldownEnd = 0;     // timestamp –∫–æ–ª–∏ –º–æ–∂–Ω–∞ –∑–Ω–æ–≤—É –ø—ñ–¥–ª–∏–≤–∞—Ç–∏
    let shaveCooldownEnd = 0;     // timestamp –∫–æ–ª–∏ –º–æ–∂–Ω–∞ –∑–Ω–æ–≤—É –≥–æ–ª–∏—Ç–∏
    let hair = true;

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    if (localStorage.getItem('penisGame')) {
        const saved = JSON.parse(localStorage.getItem('penisGame'));
        length = saved.length || 5;
        lastTime = saved.lastTime || Date.now();
        waterCooldownEnd = saved.waterCooldownEnd || 0;
        shaveCooldownEnd = saved.shaveCooldownEnd || 0;
        hair = saved.hair !== false;
    }

    function calculateOffline() {
        const now = Date.now();
        const secondsPassed = (now - lastTime) / 1000;
        let rate = 0.0008; // \~2.88 —Å–º/–≥–æ–¥ –±–∞–∑–æ–≤–æ

        if (now < waterCooldownEnd) rate *= 3;     // –±—É—Å—Ç –≤—ñ–¥ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–ª–∏–≤—É
        if (now < shaveCooldownEnd) rate *= 2.5;
        if (!hair) rate *= 1.4;

        length += secondsPassed * rate;
        if (length > 200) length = 2000; // –Ω–æ–≤–∏–π –º–∞–∫—Å–∏–º—É–º 200 —Å–º

        lastTime = now;
        saveGame();
    }

    function saveGame() {
        localStorage.setItem('penisGame', JSON.stringify({
            length, lastTime, waterCooldownEnd, shaveCooldownEnd, hair
        }));
    }

    // –ú–∞–ª—é–≤–∞–Ω–Ω—è (—Ç–µ —Å–∞–º–µ, —Ç—ñ–ª—å–∫–∏ max height –∞–¥–∞–ø—Ç–æ–≤–∞–Ω–æ)
    function draw() {
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(0, 0, w, h*0.6);
        ctx.fillStyle = '#4CAF50';
        ctx.fillRect(0, h*0.6, w, h);

        ctx.fillStyle = '#FFEB3B';
        ctx.beginPath(); ctx.arc(w*0.8, h*0.15, 40, 0, Math.PI*2); ctx.fill();

        const scale = Math.min(1, length / 100); // –º–∞—Å—à—Ç–∞–± –¥–æ 200 —Å–º
        const penisHeight = 180 + scale * 400;   // –≤—ñ–¥ 180 –¥–æ \~580px
        const centerX = w / 2;
        const baseY = h * 0.75;

        ctx.fillStyle = '#C68642';
        ctx.beginPath();
        ctx.ellipse(centerX - 28, baseY + 20, 32, 25, 0, 0, Math.PI*2);
        ctx.ellipse(centerX + 28, baseY + 20, 32, 25, 0, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = '#D38E5F';
        ctx.fillRect(centerX - 22, baseY - penisHeight + 30, 44, penisHeight);

        ctx.fillStyle = '#E07A5F';
        ctx.beginPath();
        ctx.ellipse(centerX, baseY - penisHeight + 25, 26, 18, 0, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.beginPath();
        ctx.ellipse(centerX-8, baseY - penisHeight + 22, 10, 6, 0, 0, Math.PI*2);
        ctx.fill();

        if (hair && length > 8) {
            ctx.strokeStyle = '#3D2B1F';
            ctx.lineWidth = 6;
            for (let i = -20; i <= 20; i += 8) {
                ctx.beginPath();
                ctx.moveTo(centerX + i, baseY - 40);
                ctx.lineTo(centerX + i + (Math.random()*6-3), baseY - 80);
                ctx.stroke();
            }
        }

        ctx.fillStyle = '#2E7D32';
        ctx.fillRect(0, baseY + 45, w, h - baseY - 45);
    }

    const waterBtn = document.getElementById('water');
    const shaveBtn = document.getElementById('shave');

    function updateButtons() {
        const now = Date.now();

        // –ü—ñ–¥–ª–∏—Ç–∏
        if (now < waterCooldownEnd) {
            const remain = Math.ceil((waterCooldownEnd - now) / 1000);
            const hours = Math.floor(remain / 3600);
            const mins = Math.floor((remain % 3600) / 60);
            const secs = remain % 60;
            waterBtn.textContent = `–ü—ñ–¥–ª–∏—Ç–∏ —á–µ—Ä–µ–∑ \( {hours}: \){mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            waterBtn.disabled = true;
            waterBtn.style.background = '#555';
        } else {
            waterBtn.textContent = 'üíß –ü—ñ–¥–ª–∏—Ç–∏';
            waterBtn.disabled = false;
            waterBtn.style.background = 'var(--tg-theme-button-color, #2481cc)';
        }

        // –ü–æ–±—Ä–∏—Ç–∏
        if (now < shaveCooldownEnd) {
            const remain = Math.ceil((shaveCooldownEnd - now) / 1000);
            const mins = Math.floor(remain / 60);
            const secs = remain % 60;
            shaveBtn.textContent = `–ü–æ–±—Ä–∏—Ç–∏ —á–µ—Ä–µ–∑ \( {mins}: \){secs.toString().padStart(2,'0')}`;
            shaveBtn.disabled = true;
            shaveBtn.style.background = '#555';
        } else {
            shaveBtn.textContent = '‚úÇÔ∏è –ü–æ–±—Ä–∏—Ç–∏';
            shaveBtn.disabled = false;
            shaveBtn.style.background = 'var(--tg-theme-button-color, #2481cc)';
        }
    }

    function loop() {
        calculateOffline();
        updateButtons();

        const now = Date.now();
        let status = "–†–æ—Å—Ç–µ —Å–∞–º –ø–æ —Å–æ–±—ñ...";
        if (now < waterCooldownEnd) status = "üíß –ü—ñ–¥—Å–∏–ª–µ–Ω–∏–π –ø–æ–ª–∏–≤–æ–º!";
        else if (now < shaveCooldownEnd) status = "‚úÇÔ∏è –ü—ñ—Å–ª—è –≥–æ–ª—ñ–Ω–Ω—è —Ä–æ—Å—Ç–µ —à–≤–∏–¥—à–µ!";
        else if (!hair) status = "–ì–æ–ª–∏–π = —Ä–æ—Å—Ç–µ —à–≤–∏–¥—à–µ!";

        document.getElementById('length').textContent = `–ß–ª–µ–Ω: ${length.toFixed(1)} —Å–º`;
        document.getElementById('status').textContent = status;

        draw();
        requestAnimationFrame(loop);
    }

    // –ü—ñ–¥–ª–∏—Ç–∏
    waterBtn.addEventListener('click', () => {
        const now = Date.now();
        if (now < waterCooldownEnd) {
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        tg.HapticFeedback.impactOccurred('heavy');
        length += 5;  // –±—ñ–ª—å—à–∏–π –±–æ–Ω—É—Å, –±–æ —Ä—ñ–¥–∫–æ
        waterCooldownEnd = now + 4 * 60 * 60 * 1000; // 4 –≥–æ–¥–∏–Ω–∏
        if (length > 200) length = 200;
        saveGame();
    });

    // –ü–æ–±—Ä–∏—Ç–∏
    shaveBtn.addEventListener('click', () => {
        const now = Date.now();
        if (now < shaveCooldownEnd) {
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        tg.HapticFeedback.impactOccurred('medium');
        length += 2.5;
        hair = false;
        shaveCooldownEnd = now + 30 * 60 * 1000; // 30 —Ö–≤–∏–ª–∏–Ω –∫—É–ª–¥–∞—É–Ω
        setTimeout(() => { hair = true; saveGame(); updateButtons(); }, 30 * 60 * 1000);

        if (length > 200) length = 200;
        saveGame();
    });

    tg.MainButton.onClick(() => {
        tg.sendData(JSON.stringify({ length: length.toFixed(1), action: "share" }));
        tg.showAlert(`–¢–≤—ñ–π —á–ª–µ–Ω ${length.toFixed(1)} —Å–º üî•\n–ü–æ–¥—ñ–ª–∏—Å—å –∑ –¥—Ä—É–∑—è–º–∏!`);
    });

    calculateOffline();
    loop();

    window.addEventListener('resize', () => {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    });
</script>
